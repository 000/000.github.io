<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายงานข้อเท็จจริงและลำดับเหตุการณ์เชิงโต้ตอบ: โครงการเช่าใช้บริการแพลตฟอร์ม DSL</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Inspired by minimalist aesthetics (Steve Jobs' style) and professional vibrancy */
            --color-bg: #F4F4F8;
            --color-text: #1D1D1F; /* Almost Black */
            --color-primary: #0071E3; /* Professional Blue */
            --color-accent-vibrant: #E63946; /* Sophisticated Red - for Conflicts/Highlights */
            --color-process: #4ECDC4; /* Turquoise - for Process/Meetings */
            --color-document: #A0A0A0; /* Gray - for Actions/Documents */
            --color-card-bg: #FFFFFF;
            --shadow-subtle: 0 5px 15px rgba(0, 0, 0, 0.05);
            --shadow-strong: 0 15px 35px rgba(0, 0, 0, 0.1);
            --font-main: 'IBM Plex Sans Thai', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 0;
            line-height: 1.7;
        }

        /* Header Design: Minimalist and Authoritative */
        header {
            background-color: var(--color-text);
            color: #F5F5F7;
            padding: 2.5rem 5%;
            text-align: center;
            box-shadow: var(--shadow-strong);
        }

        header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        header p {
            margin-top: 0.8rem;
            font-size: 1.1rem;
            color: var(--color-primary);
            font-weight: 300;
        }

        /* Navigation: Sticky and Intuitive (UX Principle: Visibility) */
        nav {
            position: sticky;
            top: 0;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            z-index: 1000;
            box-shadow: var(--shadow-subtle);
        }

        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
        }

        nav ul li a {
            text-decoration: none;
            color: var(--color-text);
            padding: 1rem 1.5rem;
            display: block;
            transition: color 0.3s ease, border-bottom 0.3s ease;
            font-weight: 600;
        }

        nav ul li a:hover {
            color: var(--color-primary);
            border-bottom: 3px solid var(--color-primary);
        }

        main {
            padding: 3rem 5%;
            max-width: 1600px;
            margin: auto;
        }

        /* Section Styling: Card-based layout (UX Principle: Aesthetic and Minimalist Design) */
        section {
            margin-bottom: 3rem;
            padding: 2.5rem;
            background-color: var(--color-card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-subtle);
            transition: box-shadow 0.3s ease;
        }

        section:hover {
            box-shadow: var(--shadow-strong);
        }

        h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 2rem;
        }

        /* Infographic Elements */
        .intro-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .card {
            padding: 1.5rem;
            border-radius: 12px;
            background-color: var(--color-bg);
        }

        .card h3 {
            margin-top: 0;
            font-size: 1.3rem;
        }

        /* D3 Visualization Styles */
        .tooltip {
            position: absolute;
            text-align: left;
            padding: 15px;
            font-size: 14px;
            background: rgba(29, 29, 31, 0.95);
            color: #fff;
            border-radius: 8px;
            pointer-events: none;
            max-width: 450px;
            box-shadow: var(--shadow-strong);
            transition: opacity 0.2s;
            opacity: 0;
            z-index: 1001;
            line-height: 1.5;
        }

        /* Timeline Specific Styles */
        .controls {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 12px 25px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-family: var(--font-main);
            font-weight: 600;
        }

        .button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .timeline-axis text {
            font-size: 12px;
            fill: #666;
        }

        .event-group {
            cursor: pointer;
        }

        .event-circle {
            transition: r 0.3s ease, stroke-width 0.3s ease;
        }

        .event-group:hover .event-circle {
            r: 12;
            stroke-width: 4;
        }

        .event-label {
            font-size: 14px;
            font-weight: 400;
            transition: font-weight 0.3s ease, fill 0.3s ease;
        }

        .event-group:hover .event-label {
            font-weight: 700;
            fill: var(--color-text);
        }

        /* Conflict Map Specific Styles */
        #conflict-map-container {
            overflow: hidden; /* Prevents scrollbars during transitions */
        }

        .node circle {
            cursor: pointer;
            stroke-width: 2px;
            transition: fill 0.3s ease, stroke-width 0.3s ease, r 0.3s ease;
        }

        .node:hover circle {
            stroke-width: 4px;
            r: 12;
        }

        .node text {
            font-size: 12px;
            pointer-events: none;
            fill: var(--color-text);
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
            transition: stroke 0.3s ease, stroke-width 0.3s ease;
        }

        .link-conflict {
            stroke: var(--color-accent-vibrant);
            stroke-dasharray: 5, 5;
        }

        /* Insights Styles */
        .insights-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .insight-box {
            padding: 2rem;
            border-radius: 12px;
            transition: transform 0.3s ease;
        }

        .insight-box h3 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
        }

        .insight-critical {
            border: 2px solid var(--color-accent-vibrant);
            background-color: #fff5f5;
        }
        .insight-critical h3 {
            color: var(--color-accent-vibrant);
        }

        .insight-process {
            border: 2px solid var(--color-process);
            background-color: #f0fdfa;
        }
        .insight-process h3 {
            color: var(--color-process);
        }

        .insight-legal {
            border: 2px solid var(--color-primary);
            background-color: #f0f8ff;
        }
        .insight-legal h3 {
            color: var(--color-primary);
        }

        footer {
            background-color: var(--color-text);
            color: #F5F5F7;
            text-align: center;
            padding: 2rem 5%;
            margin-top: 4rem;
        }

        /* Self-Righteous Affirmation Styling */
        .affirmation {
            background-color: #E8F0FE;
            padding: 1.5rem;
            border-radius: 12px;
            font-style: italic;
            color: var(--color-primary);
            border-left: 5px solid var(--color-primary);
            margin-top: 2rem;
            font-weight: 600;
        }

        @media (max-width: 1024px) {
            .insights-container {
                grid-template-columns: 1fr;
            }
            header h1 {
                font-size: 2rem;
            }
            nav ul {
                flex-wrap: wrap;
            }
        }

    </style>
</head>
<body>

    <header>
        <h1>การวิเคราะห์ลำดับเหตุการณ์และข้อเท็จจริงเชิงลึก</h1>
        <p>โครงการเช่าใช้บริการแพลตฟอร์มเทคโนโลยีดิจิทัลสำหรับให้บริการระบบ DSL (๖๐ เดือน)</p>
    </header>

    <nav>
        <ul>
            <li><a href="#introduction">บทสรุปสำหรับผู้บริหาร</a></li>
            <li><a href="#timeline-section">ลำดับเหตุการณ์สำคัญ (Timeline)</a></li>
            <li><a href="#conflict-map-section">แผนผังประเด็นข้อพิพาท (Conflict Map)</a></li>
            <li><a href="#insights-section">บทวิเคราะห์และข้อสังเกต</a></li>
        </ul>
    </nav>

    <main>
        <section id="introduction">
            <h2>บทสรุปสำหรับผู้บริหาร (Executive Summary)</h2>
            <p>เอกสาร Visualization ฉบับนี้จัดทำขึ้นเพื่อวิเคราะห์ข้อมูลจากรายงานข้อเท็จจริงของนายธนัท ทองอุทัยศรี โดยมุ่งเน้นการแสดงความเชื่อมโยงของเหตุการณ์ ประเด็นความขัดแย้งในการตีความข้อกำหนด (TOR) และระเบียบพัสดุฯ ที่นำไปสู่การยกเลิกการจัดจ้าง</p>
            
            <div class="intro-grid">
                <div class="card">
                    <h3 style="color: var(--color-process);">ภาพรวมกระบวนการ</h3>
                    <p>กระบวนการจัดจ้างเริ่มตั้งแต่ 24 มิ.ย. 68 ถึง 28 ส.ค. 68 มีการประชุมรวม 7 ครั้ง มีผู้ยื่นข้อเสนอ 3 ราย กระบวนการมีความซับซ้อนเนื่องจากการตีความข้อกำหนดที่ไม่ตรงกันและการพบข้อบกพร่องของ TOR ในภายหลัง</p>
                </div>
                <div class="card">
                    <h3 style="color: var(--color-accent-vibrant);">จุดแตกหัก (Conflict Origin)</h3>
                    <p>การประชุมครั้งที่ 5/2568 (30 ก.ค. 68) เป็นจุดสำคัญ เมื่อพบว่าผู้ยื่น 2 รายมีเอกสารบุคลากรไม่ครบตาม TOR 12.2 นำไปสู่การโต้แย้งว่าควร "ตกเทคนิค" หรือเพียง "ไม่ได้คะแนน" และส่งผลต่อการบังคับใช้ระเบียบข้อ 75 (เหลือรายเดียว) หรือไม่</p>
                </div>
                <div class="card">
                    <h3 style="color: var(--color-primary);">สาเหตุการยกเลิก (Cancellation Cause)</h3>
                    <p>การยกเลิกในการประชุมครั้งที่ 7/2568 มีสาเหตุหลักมาจากการที่ฝ่ายเทคโนโลยีฯ (ฝทส.) รายงานข้อบกพร่องของ TOR และผู้จัดการกองทุนฯ อนุมัติให้ "ทบทวน TOR" ทำให้ TOR เดิมสิ้นสภาพการบังคับใช้</p>
                </div>
            </div>
            <div class="affirmation">
                "ข้าพเจ้า (นายธนัท ทองอุทัยศรี) ขอยืนยันว่าการปฏิบัติหน้าที่และการสงวนความเห็นแย้ง ได้ดำเนินการโดยสุจริต รอบคอบ ยึดมั่นในระเบียบและ TOR อย่างเคร่งครัด เพื่อรักษาผลประโยชน์สูงสุดของกองทุนฯ และหลักการแข่งขันที่เป็นธรรม มิได้มีการเลือกปฏิบัติหรือใช้ดุลยพินิจโดยปราศจากฐานทางเอกสารรองรับ"
            </div>
        </section>

        <section id="timeline-section">
            <h2>ลำดับเหตุการณ์สำคัญ (Interactive Timeline)</h2>
            <p>ไทม์ไลน์แสดงรายละเอียดเหตุการณ์ที่เกิดขึ้น เลื่อนเมาส์ไปที่เหตุการณ์เพื่อดูรายละเอียด หรือใช้ปุ่มควบคุมเพื่อกรองประเภทเหตุการณ์</p>
            <div class="controls">
                <button class="button" onclick="filterTimeline('all')">แสดงทั้งหมด</button>
                <button class="button" onclick="filterTimeline('meeting')" style="background-color: var(--color-process); color: var(--color-text);">การประชุม</button>
                <button class="button" onclick="filterTimeline('action')" style="background-color: var(--color-document); color: var(--color-text);">การดำเนินการ/เอกสาร</button>
                <button class="button" onclick="filterTimeline('conflict')" style="background-color: var(--color-accent-vibrant);">จุดเปลี่ยน/ข้อพิพาท</button>
            </div>
            <div id="timeline-container">
                <svg id="timeline-svg"></svg>
            </div>
        </section>

        <section id="conflict-map-section">
            <h2>แผนผังประเด็นข้อพิพาทและการตีความ (Conflict & Interpretation Map)</h2>
            <p>แสดงความเชื่อมโยงระหว่างข้อกำหนด TOR, ระเบียบพัสดุฯ, ข้อเท็จจริง และมุมมองที่แตกต่างกันของผู้เกี่ยวข้อง กดที่โหนด (วงกลม) เพื่อขยาย/ยุบรายละเอียด</p>
            <div class="controls">
                <button id="toggleLayoutButton" class="button">เปลี่ยนเป็นมุมมองแบบรัศมี (Radial Layout)</button>
            </div>
            <div id="conflict-map-container">
                <svg id="conflict-map-svg"></svg>
            </div>
        </section>

        <section id="insights-section">
            <h2>ข้อสังเกตและบทวิเคราะห์สำคัญ (Key Insights & Analysis)</h2>
            <div class="insights-container">
                <div class="insight-box insight-critical">
                    <h3>1. ความย้อนแย้งในการตีความ TOR ข้อ 12.2</h3>
                    <p>TOR หน้า 48 ระบุเงื่อนไขชัดเจนว่าการขาดเอกสารบุคลากร "...ถือว่าไม่ผ่านข้อเสนอทางเทคนิค". การที่มติเสียงข้างมากในการประชุมครั้งที่ 5 ตีความว่าเป็นการ "ไม่ได้คะแนน" เป็นการใช้ดุลยพินิจที่ขัดแย้งกับลายลักษณ์อักษรอย่างชัดเจน</p>
                </div>
                <div class="insight-box insight-legal">
                    <h3>2. การหลีกเลี่ยงการบังคับใช้ระเบียบข้อ 75</h3>
                    <p>เมื่อข้อเท็จจริงชี้ว่าเหลือผู้ผ่านเทคนิครายเดียวตาม TOR การพยายามหลีกเลี่ยงการเข้าสู่กระบวนการพิจารณาตามระเบียบข้อ 75 (การยกเลิกหรือหาเหตุผลสมควรเพื่อดำเนินการต่อ) สะท้อนถึงความเสี่ยงด้านธรรมาภิบาลและการถูกตรวจสอบในอนาคต</p>
                </div>
                <div class="insight-box insight-process">
                    <h3>3. การเปลี่ยนแปลงเหตุผลในการยกเลิก (Shifting Rationale)</h3>
                    <p>แม้ข้อพิพาทเริ่มต้นที่การตีความข้อ 75 แต่การยกเลิกในท้ายที่สุดกลับอ้างอิงเหตุผลเรื่อง "TOR มีข้อบกพร่อง" (ตามรายงาน ฝทส.) และผู้จัดการกองทุนฯ อนุมัติให้ทบทวน ซึ่งทำให้ TOR เดิมสิ้นสภาพไป</p>
                </div>
                <div class="insight-box insight-critical">
                    <h3>4. ข้อบกพร่องของ TOR ที่ถูกหยิบยกในภายหลัง</h3>
                    <p>ประเด็นข้อบกพร่องของ TOR (เช่น GPU 30 หน่วย/Node, ประกันสังคม) ถูกรายงานโดย ฝทส. หลังจากเกิดข้อพิพาทเรื่องคุณสมบัติบุคลากรแล้ว ทำให้เกิดข้อสังเกตเกี่ยวกับช่วงเวลาในการค้นพบปัญหาเหล่านี้</p>
                </div>
                
                <div class="insight-box insight-process">
                    <h3>5. การสื่อสารกับภายนอกที่ไม่รัดกุม</h3>
                    <p>การที่ประธานฯ มีหนังสือถึง ProEN (7 ส.ค.) โดยเปิดเผยรายละเอียดการลงมติและความเห็นต่างภายใน (Internal Deliberation) ในขณะที่ยังไม่มีข้อยุติ เป็นการดำเนินการที่อาจสร้างความเสียเปรียบให้กองทุนฯ ในกรณีพิพาท (ตามข้อสังเกตของนายธนัท)</p>
                </div>
                <div class="insight-box insight-legal">
                    <h3>6. บทบาทของแผนสำรอง (Contingency Plan)</h3>
                    <p>การที่กองทุนฯ มีแผนสำรอง ทำให้ไม่มีความจำเป็นเร่งด่วนที่จะต้องดำเนินการจัดจ้างภายใต้ความเสี่ยงทางกฎหมายและ TOR ที่มีปัญหา ซึ่งสนับสนุนความเห็นแย้งของนายธนัทที่เสนอให้ยกเลิกและดำเนินการใหม่ด้วยความรอบคอบ</p>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>ข้อมูลอ้างอิงตามบันทึกข้อความของนายธนัท ทองอุทัยศรี (พฤศจิกายน 2568) | Interactive Visualization Powered by D3.js</p>
    </footer>

    <div id="tooltip" class="tooltip"></div>

    <script>
        // --- 1. Data Definition (Embedded) ---
        // ข้อมูลสกัดจากเอกสารที่ให้มาอย่างเคร่งครัด
        const timelineData = [
            { date: "2568-06-24", type: "action", category: "เริ่มต้นโครงการ", title: "แต่งตั้งคณะกรรมการเช่าฯ", description: "กองทุนฯ ออกคำสั่ง ที่ ๙๙/๒๕๖๘ แต่งตั้งคณะกรรมการเช่าโดยวิธีคัดเลือกโครงการ DSL ระยะเวลา ๖๐ เดือน นายธนัท ทองอุทัยศรี เป็นกรรมการ.", ref: "ข้อ 2.1" },
            { date: "2568-07-01", type: "meeting", category: "กำหนดหลักเกณฑ์", title: "ประชุมครั้งที่ 1 และ 2/2568", description: "พิจารณา TOR, หลักเกณฑ์ Price Performance และเห็นชอบรายชื่อผู้ประกอบการ 12 รายเพื่อเชิญชวน.", ref: "ข้อ 2.2" },
            { date: "2568-07-02", type: "action", category: "เชิญชวน", title: "ออกหนังสือเชิญชวน", description: "กองทุนฯ ออกหนังสือเชิญชวน (ที่ กค ๕๑๐๑/ว.๒๒๘๐) ถึง 12 ราย กำหนดยื่นข้อเสนอภายใน 22 ก.ค. 2568.", ref: "ข้อ 2.3" },
            { date: "2568-07-14", type: "meeting", category: "ชี้แจง TOR", title: "ประชุมครั้งที่ 3/2568", description: "พิจารณาและตอบข้อซักถามเกี่ยวกับ TOR จากผู้ประกอบการ 8 ราย เผยแพร่ผ่าน e-GP.", ref: "ข้อ 2.4" },
            { date: "2568-07-22", type: "action", category: "ยื่นข้อเสนอ", title: "วันครบกำหนดยื่นข้อเสนอ", description: "มีผู้ยื่นข้อเสนอ 3 ราย: (1) บ.โทรคมนาคมแห่งชาติ (NT), (2) บ.สิริซอฟต์ (SiriSoft), (3) บ.โปรเอ็น คอร์ป (ProEN).", ref: "ข้อ 2.5" },
            { date: "2568-07-24", type: "meeting", category: "พิจารณาผลเบื้องต้น", title: "ประชุมครั้งที่ 4/2568 (เปิดซอง)", description: "เปิดซองราคา. ผลเบื้องต้น ProEN คะแนนสูงสุด (85.1149). มอบหมายฝ่ายเลขาฯ ตรวจสอบเอกสารบุคลากรตาม TOR 12.2 อย่างละเอียด.", ref: "ข้อ 2.6" },
            { date: "2568-07-30", type: "conflict", category: "ข้อพิพาทหลัก", title: "ประชุมครั้งที่ 5/2568: จุดเริ่มต้นข้อพิพาท", description: "ฝ่ายเลขาฯ แจ้งว่า NT และ SiriSoft เอกสารบุคลากรไม่ครบตาม TOR 12.2 (ซึ่งระบุว่าถือว่าตกเทคนิค). เกิดความเห็นต่างในการตีความระเบียบข้อ 75. มติเสียงข้างมาก (4:1) ให้ดำเนินการต่อ. นายธนัทสงวนความเห็นแย้ง.", ref: "ข้อ 2.7, 3.3" },
            { date: "2568-07-31", type: "action", category: "การทักท้วง", title: "ฝอพ. เสนอทบทวนมติ", description: "ฝ่ายอำนวยการและพัสดุ (ฝอพ.) ทำบันทึก (ฝอพ.๑๕๒๗/๒๕๖๘) ทักท้วงมติครั้งที่ 5 ชี้ว่าควรเข้าข้อ 56 และ 75 (เหลือรายเดียว).", ref: "ข้อ 2.8, 4.1" },
            { date: "2568-08-01", type: "conflict", category: "การทบทวน TOR", title: "ฝทส. เสนอทบทวน TOR และผู้จัดการฯ เห็นชอบ", description: "ฝ่ายเทคโนโลยีฯ (ฝทส.) ทำบันทึก (ฝทส.๙๖๑/๒๕๖๘) ชี้ว่า TOR มีข้อบกพร่องสำคัญ (GPU, เอกสารบุคลากร, ประกันสังคม) และแจ้งว่ามีแผนสำรอง. ผู้จัดการกองทุนฯ เห็นชอบให้ทบทวน TOR.", ref: "ข้อ 2.9, 4.2" },
            { date: "2568-08-04", type: "meeting", category: "หารือภายนอก", title: "ประชุมครั้งที่ 6/2568", description: "มติให้ส่งเรื่องหารือคณะกรรมการวินิจฉัยฯ กรมบัญชีกลาง เรื่องการตีความข้อ 75 และขอขยายเวลา. ยังไม่มีมติยกเลิก.", ref: "ข้อ 2.10, 4.3" },
            { date: "2568-08-07", type: "action", category: "การสื่อสาร (ข้อสังเกต)", title: "หนังสือชี้แจง ProEN", description: "ประธานฯ มีหนังสือ (กค ๕๑๒๒/ว.๒๗๙๑) ถึง ProEN ชี้แจงความคืบหน้า โดยเปิดเผยรายละเอียดความเห็นต่างภายใน (นายธนัททักท้วงภายหลังว่าไม่เหมาะสม).", ref: "ข้อ 2.11, 5.1" },
            { date: "2568-08-22", type: "conflict", category: "การยกเลิก", title: "ประชุมครั้งที่ 7/2568: มติยกเลิกการจัดจ้าง", description: "ที่ประชุมสรุปว่า การที่ผู้จัดการกองทุนฯ อนุมัติให้ทบทวน TOR ทำให้ TOR เดิมสิ้นสภาพ ไม่สามารถดำเนินการต่อได้. มติเห็นชอบให้เสนอผู้จัดการกองทุนฯ ยกเลิกการจัดจ้าง.", ref: "ข้อ 2.12, 4.4" },
            { date: "2568-08-28", type: "action", category: "สิ้นสุดกระบวนการ", title: "แจ้งยกเลิกการจัดจ้าง", description: "กองทุนฯ มีหนังสือ (กค ๕๑๐๑/ว.๓๑๓๓) แจ้งยกเลิกการจัดจ้างไปยังผู้ยื่นข้อเสนอ 3 ราย.", ref: "ข้อ 2.13" },
            { date: "2568-09-23", type: "action", category: "การอุทธรณ์", title: "ProEN ยื่นอุทธรณ์", description: "บริษัท ProEN ยื่นอุทธรณ์คำสั่งยกเลิก (เลขที่ PROEN 68/0923-1).", ref: "อ้างอิงในข้อ 2.13" },
            { date: "2568-11-14", type: "action", category: "การสอบสวน", title: "คณะกรรมการสอบสวนฯ ขอรายงาน", description: "คณะกรรมการสอบสวนข้อเท็จจริง (ประธาน: นายอภินันช์) ขอให้นายธนัท รายงานข้อเท็จจริง (ฝทบ.ว 1558/2568).", ref: "ข้อ 1.1" },
        ];

        // Data structure for Conflict Map (Hierarchical/Radial)
        const conflictData = {
            name: "สาเหตุและข้อพิพาทในการยกเลิกโครงการ DSL",
            children: [
                {
                    name: "ประเด็นที่ 1: การตีความ TOR ข้อ 12.2 (คุณสมบัติบุคลากร)",
                    type: "conflict",
                    children: [
                        { name: "ข้อเท็จจริง: NT และ SiriSoft เอกสารไม่ครบ", type: "fact" },
                        { name: "TOR หน้า 48: '...ถือว่าไม่ผ่านข้อเสนอทางเทคนิค'", type: "rule" },
                        {
                            name: "มุมมองที่ 1: ตกเทคนิค (ยึดตาม TOR)",
                            type: "conflict",
                            children: [
                                { name: "ผู้สนับสนุน: นายธนัท (เสียงข้างน้อย), ฝ่ายเลขาฯ, ฝอพ.", type: "actor" },
                                { name: "ผลกระทบ: เหลือผู้ผ่านรายเดียว (ProEN)", type: "impact" }
                            ]
                        },
                        {
                            name: "มุมมองที่ 2: ไม่ตกเทคนิค (แค่ไม่ได้คะแนน)",
                            children: [
                                { name: "ผู้สนับสนุน: กรรมการเสียงข้างมาก 4 ท่าน (นายปรเมศวร์, ผศ.ดร.สมนึก, นายภาณุวัตร, นายทนงเดช)", type: "actor" },
                                { name: "เหตุผล: ผ่าน Qualification เบื้องต้น (ซอง 1) แล้ว", type: "reason" },
                                { name: "ผลกระทบ: ผ่านเทคนิคทั้ง 3 ราย", type: "impact" }
                            ]
                        },
                        {
                            name: "มติที่ประชุมครั้งที่ 5 (30 ก.ค.)",
                            children: [
                                { name: "มติ (4:1): เห็นชอบตามมุมมองที่ 2 (ดำเนินการต่อ)", type: "decision" }
                            ]
                        }
                    ]
                },
                {
                    name: "ประเด็นที่ 2: การบังคับใช้ระเบียบฯ ข้อ 75",
                    type: "conflict",
                    children: [
                        { name: "ระเบียบข้อ 75: หากเหลือผู้ถูกต้องเพียงรายเดียว ให้เสนอ 'ยกเลิก' (เว้นมีเหตุผลสมควร)", type: "rule" },
                        {
                            name: "การตีความสถานการณ์",
                            children: [
                                { name: "มุมมองที่ 1: เข้าเงื่อนไขข้อ 75 (ต้องยกเลิก/หาเหตุผล)", type: "conflict" },
                                { name: "มุมมองที่ 2: ไม่เข้าเงื่อนไขข้อ 75" }
                            ]
                        },
                        {
                            name: "การดำเนินการ",
                            children: [
                                { name: "ฝอพ. ทักท้วง (31 ก.ค.)", type: "action" },
                                { name: "มติครั้งที่ 6 (4 ส.ค.): ส่งหารือกรมบัญชีกลาง (รอความชัดเจน)", type: "decision" }
                            ]
                        }
                    ]
                },
                {
                    name: "ประเด็นที่ 3: ข้อบกพร่องของ TOR (เหตุผลหลักในการยกเลิก)",
                    type: "decision",
                    children: [
                        {
                            name: "ฝทส. รายงานข้อบกพร่อง TOR (1 ส.ค.)",
                            type: "action",
                            children: [
                                { name: "GPU 30 หน่วย/Node (สับสน/ขัดมาตรฐาน)", type: "issue" },
                                { name: "ความไม่สอดคล้องเรื่องเอกสารบุคลากร", type: "issue" },
                                { name: "หลักฐานประกันสังคม (อาจกีดกันรัฐวิสาหกิจ)", type: "issue" }
                            ]
                        },
                        {
                            name: "ผู้จัดการกองทุนฯ อนุมัติทบทวน TOR (1 ส.ค.)",
                            type: "decision"
                        },
                        {
                            name: "มติที่ประชุมครั้งที่ 7 (22 ส.ค.)",
                            type: "decision",
                            children: [
                                { name: "การตีความโดย ผอ.ฝอพ.: การอนุมัติทบทวน = ยกเลิก TOR เดิม", type: "reason" },
                                { name: "เหตุผล: TOR เดิมสิ้นสภาพ ไม่สามารถดำเนินการต่อได้", type: "reason" },
                                { name: "มติ: ยกเลิกการจัดจ้าง", type: "decision" }
                            ]
                        }
                    ]
                }
            ]
        };

        // --- 2. Visualization Setup ---

        const tooltip = d3.select("#tooltip");
        
        // Function to parse Buddhist Era (BE) dates correctly to Common Era (CE)
        // JavaScript Date objects work internally with CE.
        const parseBEdate = (beDateString) => {
            const [yearBE, month, day] = beDateString.split('-').map(Number);
            // Convert BE year to CE year (BE - 543 = CE)
            const yearCE = yearBE - 543;
            // Month index is 0-based in JavaScript Date
            return new Date(yearCE, month - 1, day);
        };

        // Color mapping based on CSS variables
        const typeColors = {
            meeting: getComputedStyle(document.documentElement).getPropertyValue('--color-process').trim(),
            action: getComputedStyle(document.documentElement).getPropertyValue('--color-document').trim(),
            conflict: getComputedStyle(document.documentElement).getPropertyValue('--color-accent-vibrant').trim(),
        };

        // Pre-process data
        timelineData.forEach(d => {
            d.dateObj = parseBEdate(d.date);
        });

        // Set locale to Thai for date formatting output
        d3.timeFormatDefaultLocale({
            "dateTime": "%Aที่ %e %B %Y",
            "date": "%d/%m/%Y",
            "time": "%H:%M:%S",
            "periods": ["AM", "PM"],
            "days": ["วันอาทิตย์", "วันจันทร์", "วันอังคาร", "วันพุธ", "วันพฤหัสบดี", "วันศุกร์", "วันเสาร์"],
            "shortDays": ["อา.", "จ.", "อ.", "พ.", "พฤ.", "ศ.", "ส."],
            "months": ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"],
            "shortMonths": ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."]
        });
        
        // Function to format date output, manually adding BE year
        const formatThaiDate = (date) => {
            const formatter = d3.timeFormat("%d %B");
            const yearBE = date.getFullYear() + 543;
            return `${formatter(date)} ${yearBE}`;
        };


        // --- 3. Timeline Visualization (Vertical Layout) ---
        function initTimeline() {
            const margin = { top: 40, right: 50, bottom: 50, left: 180 };
            const containerWidth = document.getElementById('timeline-container').clientWidth;
            
            // Dynamic height based on the number of events
            const calculatedHeight = timelineData.length * 95; 
            const height = Math.max(calculatedHeight, 600); // Ensure minimum height

            const width = containerWidth - margin.left - margin.right;

            // Clear previous rendering
            d3.select("#timeline-svg").selectAll("*").remove();

            const svg = d3.select("#timeline-svg")
                .attr("width", containerWidth)
                .attr("height", height + margin.top + margin.bottom);

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Scales
            // Using scaleTime for the Y-axis to ensure correct chronological order and spacing
            const yScale = d3.scaleTime()
                .domain(d3.extent(timelineData, d => d.dateObj))
                .range([0, height]);

            // Axis (The timeline itself)
            const yAxis = d3.axisLeft(yScale)
                .tickValues(timelineData.map(d => d.dateObj)) // Ensure a tick for every event
                .tickFormat(formatThaiDate);

            g.append("g")
                .attr("class", "timeline-axis")
                .call(yAxis);

            // Draw events
            drawEvents(g, yScale, width);
        }

        function drawEvents(g, yScale, width) {
            const eventGroups = g.selectAll(".event-group")
                .data(timelineData, d => d.date + d.title)
                .enter()
                .append("g")
                .attr("class", "event-group")
                .attr("data-type", d => d.type)
                .attr("transform", d => `translate(0, ${yScale(d.dateObj)})`)
                .on("mouseover", (event, d) => {
                    tooltip.transition().duration(200).style("opacity", 1);
                    tooltip.html(`
                        <h3 style="margin-top: 0; color: ${typeColors[d.type]};">${d.title}</h3>
                        <p><strong>${formatThaiDate(d.dateObj)} - ${d.category}</strong></p>
                        <p>${d.description}</p>
                        <p><em>อ้างอิง: ${d.ref}</em></p>
                    `)
                    .style("left", (event.pageX + 15) + "px")
                    .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    tooltip.transition().duration(500).style("opacity", 0);
                });

            // Connecting lines (Horizontal) with entrance animation
            eventGroups.append("line")
                .attr("x1", 0)
                .attr("x2", 0)
                .attr("stroke", d => typeColors[d.type])
                .attr("stroke-width", 2)
                .transition().duration(1000).delay((d, i) => i * 50)
                .attr("x2", 30);

            // Event circles with entrance animation
            eventGroups.append("circle")
                .attr("class", "event-circle")
                .attr("cx", 40)
                .attr("cy", 0)
                .attr("r", 0)
                .attr("fill", d => typeColors[d.type])
                .attr("stroke", "#fff")
                .attr("stroke-width", 2)
                .transition().duration(1000).delay((d, i) => i * 50 + 300)
                .attr("r", 8);

            // Event labels with entrance animation
            eventGroups.append("text")
                .attr("class", "event-label")
                .attr("x", 60)
                .attr("y", 0)
                .attr("dy", ".35em")
                .text(d => d.title)
                .attr("fill", "#333")
                .style("opacity", 0)
                .transition().duration(1000).delay((d, i) => i * 50 + 500)
                .style("opacity", 1);
        }

        // Timeline filtering functionality
        function filterTimeline(type) {
            d3.selectAll(".event-group")
                .transition()
                .duration(500)
                .style("opacity", function() {
                    const dataType = d3.select(this).attr("data-type");
                    // Dim events that don't match the filter
                    return (type === 'all' || dataType === type) ? 1 : 0.05;
                })
                .style("pointer-events", function() {
                     const dataType = d3.select(this).attr("data-type");
                     // Disable interaction for dimmed events
                    return (type === 'all' || dataType === type) ? "auto" : "none";
                });
        }

        // --- 4. Conflict Map Visualization (Dynamic Hierarchical/Radial Tree) ---
        
        let conflictSvg, conflictG, conflictRoot;
        let duration = 750;
        let currentLayout = 'hierarchical';
        let i = 0; // counter for node ids
        let conflictContainerWidth, conflictHeight, radius;

        // Color mapping for conflict map nodes
        const conflictNodeColors = {
            default: "#f0f0f0",
            conflict: getComputedStyle(document.documentElement).getPropertyValue('--color-accent-vibrant').trim(),
            rule: getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim(),
            fact: getComputedStyle(document.documentElement).getPropertyValue('--color-process').trim(),
            decision: getComputedStyle(document.documentElement).getPropertyValue('--color-text').trim(),
        };

        function getNodeColor(d) {
            return conflictNodeColors[d.data.type] || conflictNodeColors.default;
        }

        function initConflictMap() {
            // Define dimensions based on container size
            conflictContainerWidth = document.getElementById('conflict-map-container').clientWidth;
            conflictHeight = 1000; // Adequate height for complex tree
            radius = conflictHeight / 2 - 50;

            // Clear previous rendering
            d3.select("#conflict-map-svg").selectAll("*").remove();

            conflictSvg = d3.select("#conflict-map-svg")
                .attr("width", conflictContainerWidth)
                .attr("height", conflictHeight);

            conflictG = conflictSvg.append("g");

            // Process data
            conflictRoot = d3.hierarchy(conflictData, d => d.children);
            conflictRoot.x0 = conflictHeight / 2;
            conflictRoot.y0 = 0;

            // Collapse after the first level initially for a cleaner start
            if (conflictRoot.children) {
                 conflictRoot.children.forEach(collapse);
            }

            updateConflictMap(conflictRoot);

            // Attach event listener only once
            if (!d3.select("#toggleLayoutButton").on("click")) {
                d3.select("#toggleLayoutButton").on("click", toggleLayout);
            }
        }

        function collapse(d) {
            if (d.children) {
                d._children = d.children;
                d._children.forEach(collapse);
                d.children = null;
            }
        }

        // Main update function for the tree visualization
        function updateConflictMap(source) {

            let treeLayout;
            let linkGenerator;
            
            // 1. Setup Layout and Link Generators based on current view
            if (currentLayout === 'hierarchical') {
                // Hierarchical Layout (Left to Right)
                // Adjust width dynamically, ensure minimum width if container is too small
                const availableWidth = Math.max(400, conflictContainerWidth - 400);
                treeLayout = d3.tree().size([conflictHeight, availableWidth]);
                linkGenerator = d3.linkHorizontal().x(d => d.y).y(d => d.x);
                
                // Reset transformation for hierarchical (Left margin)
                conflictG.transition().duration(duration)
                    .attr("transform", "translate(150, 0)");

            } else { 
                // Radial Layout
                treeLayout = d3.tree().size([2 * Math.PI, radius])
                    .separation((a, b) => (a.parent == b.parent ? 1 : 2) / a.depth);
                linkGenerator = d3.linkRadial().angle(d => d.x).radius(d => d.y);

                // Center the visualization for radial
                conflictG.transition().duration(duration)
                    .attr("transform", `translate(${conflictContainerWidth / 2}, ${conflictHeight / 2})`);
            }

            // Computes the new tree layout.
            const treeData = treeLayout(conflictRoot);
            const nodes = treeData.descendants();
            const links = treeData.descendants().slice(1);

            if (currentLayout === 'hierarchical') {
                // Normalize for fixed-depth in hierarchical view.
                nodes.forEach(d => { d.y = d.depth * 220; });
            }

            // ****************** Nodes section ***************************

            const node = conflictG.selectAll('g.node')
                .data(nodes, d => d.id || (d.id = ++i));

            // Enter any new nodes at the parent's previous position.
            const nodeEnter = node.enter().append('g')
                .attr('class', 'node')
                .attr("transform", d => {
                    // Start at the source's previous position (x0, y0)
                    return getTransform(source.x0, source.y0, currentLayout);
                })
                .on('click', click);

            // Add Circle for the nodes
            nodeEnter.append('circle')
                .attr('class', 'node-circle')
                .attr('r', 1e-6) // Start small for animation
                .style("fill", d => d._children ? getNodeColor(d) : "#fff")
                .attr("stroke", d => getNodeColor(d));

            // Add labels for the nodes
            nodeEnter.append('text')
                .attr("dy", ".35em")
                .text(d => d.data.name);

            // UPDATE (Merge Enter and existing nodes)
            const nodeUpdate = nodeEnter.merge(node);

            // Transition to the proper position for the node
            nodeUpdate.transition()
                .duration(duration)
                .attr("transform", d => getTransform(d.x, d.y, currentLayout));

            // Update the node attributes and style
            nodeUpdate.select('circle.node-circle')
                .attr('r', 8)
                // Fill color if collapsed (_children exists), white if expanded
                .style("fill", d => d._children ? getNodeColor(d) : "#fff")
                .attr("stroke", d => getNodeColor(d));

            // Adjust text positioning and rotation dynamically based on layout
            if (currentLayout === 'radial') {
                nodeUpdate.select("text")
                    .transition().duration(duration)
                    // Rotation based on position on the circle (d.x is in radians)
                    .attr("transform", d => d.x >= Math.PI ? "rotate(180)" : null)
                    // Anchor and position based on side of the circle and whether it has children
                    .attr("x", d => d.x < Math.PI === !d.children ? 12 : -12)
                    .attr("text-anchor", d => d.x < Math.PI === !d.children ? "start" : "end");
            } else {
                 nodeUpdate.select("text")
                    .transition().duration(duration)
                    .attr("transform", "rotate(0)")
                    // Hierarchical: Adjust text anchor based on whether it has children (expanded or collapsed)
                    .attr("x", d => d.children || d._children ? -12 : 12)
                    .attr("text-anchor", d => d.children || d._children ? "end" : "start");
            }

            // Remove any exiting nodes
            const nodeExit = node.exit().transition()
                .duration(duration)
                .attr("transform", d => getTransform(source.x, source.y, currentLayout))
                .remove();

            nodeExit.select('circle').attr('r', 1e-6);
            nodeExit.select('text').style('fill-opacity', 1e-6);

            // ****************** links section ***************************

            const link = conflictG.selectAll('path.link')
                .data(links, d => d.id);

            // Enter any new links at the parent's previous position.
            const linkEnter = link.enter().insert('path', "g")
                .attr("class", d => `link ${d.data.type === 'conflict' ? 'link-conflict' : ''}`)
                .attr('d', d => {
                    const o = { x: source.x0, y: source.y0 };
                    return linkGenerator({ source: o, target: o });
                });

            // UPDATE
            const linkUpdate = linkEnter.merge(link);

            // Transition links to their new positions
            linkUpdate.transition()
                .duration(duration)
                 .attr('d', d => linkGenerator({source: d.parent, target: d}));


            // Remove any exiting links
            const linkExit = link.exit().transition()
                .duration(duration)
                .attr('d', d => {
                    const o = { x: source.x, y: source.y };
                    return linkGenerator({ source: o, target: o });
                })
                .remove();

            // Store the old positions for transition.
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        // Helper to get transform string based on layout
        function getTransform(x, y, layout) {
             // Handle potential undefined/NaN values during transitions
             if (x === undefined || y === undefined || isNaN(x) || isNaN(y)) {
                x = 0; y = 0;
            }

            if (layout === 'hierarchical') {
                // Hierarchical (Horizontal) uses Cartesian coordinates: translate(y, x)
                return `translate(${y},${x})`;
            } else {
                // Radial uses Polar coordinates: rotate(angle) translate(radius, 0)
                // Angle calculation: (x * 180 / PI) converts radians to degrees. -90 offset starts the tree from the top.
                return `rotate(${(x * 180 / Math.PI - 90) || 0}) translate(${y},0)`;
            }
        }

        // Toggle children on click.
        function click(event, d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            updateConflictMap(d);
        }

        // Toggle layout between Hierarchical and Radial
        function toggleLayout() {
            // Stop any ongoing transitions to prevent glitches
            conflictG.selectAll("*").interrupt();

            if (currentLayout === 'hierarchical') {
                currentLayout = 'radial';
                d3.select("#toggleLayoutButton").text("เปลี่ยนเป็นมุมมองแบบลำดับชั้น (Hierarchical Layout)");
            } else {
                currentLayout = 'hierarchical';
                d3.select("#toggleLayoutButton").text("เปลี่ยนเป็นมุมมองแบบรัศมี (Radial Layout)");
            }
            
            // Update visualization with the new layout settings
            // The existing conflictRoot hierarchy retains its expanded/collapsed state.
            updateConflictMap(conflictRoot);
        }


        // --- 5. Initialization and Responsiveness ---

        // Function to handle resizing
        function handleResize() {
            // Re-initialize Timeline
            initTimeline();
            
            // Re-initialize Conflict Map to adapt to new container width
            // We need to reset the conflict map entirely to recalculate dimensions
            initConflictMap(); 
            // Ensure the update respects the current layout setting after re-initialization
            if (currentLayout === 'radial') {
                // Temporarily switch state internally to force toggleLayout to apply radial settings
                currentLayout = 'hierarchical'; 
                toggleLayout();
            }
        }

        // Initialize on load
        window.onload = () => {
            initTimeline();
            initConflictMap();
        };

        // Add event listener for resize with debounce to improve performance
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(handleResize, 250);
        });

    </script>
</body>
</html>
