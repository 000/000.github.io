<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS INTEL v12.0 // Extended Network Analysis - 42 Entities</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        @layer base, layout, components, utilities, animations;
        @layer base {
            :root {
                --space-void: #030305; --space-deep: #0a0a0f; --space-surface: #111118;
                --titanium: #86868b; --titanium-light: #a1a1a6; --silver: #f5f5f7;
                --neon-core: #3b82f6; --accent-violet: #8b5cf6; --accent-gold: #f59e0b;
                --peach-fuzz: #FFBE98; --accent-emerald: #10b981;
                --risk-critical: #ef4444; --risk-high: #f97316; --risk-medium: #eab308; --risk-low: #22c55e;
                --glass-bg: rgba(17, 17, 24, 0.75); --glass-border: rgba(255, 255, 255, 0.06);
                --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
            }
            *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
            body { background: var(--space-void); color: var(--silver); font-family: 'Inter', sans-serif; overflow-x: hidden; min-height: 100vh; }
            [lang="th"] { display: none; }
            body[data-lang="th"] [lang="en"] { display: none; }
            body[data-lang="th"] [lang="th"] { display: block; font-family: 'Sarabun', sans-serif; }
            ::-webkit-scrollbar { width: 8px; }
            ::-webkit-scrollbar-track { background: var(--space-deep); }
            ::-webkit-scrollbar-thumb { background: var(--titanium); border-radius: 4px; }
        }
        @layer layout {
            .fixed { position: fixed; } .absolute { position: absolute; } .relative { position: relative; } .sticky { position: sticky; }
            .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
            .top-4 { top: 1rem; } .right-4 { right: 1rem; } .bottom-4 { bottom: 1rem; } .left-4 { left: 1rem; }
            .z-0 { z-index: 0; } .z-10 { z-index: 10; } .z-50 { z-index: 50; } .z-9999 { z-index: 9999; }
            .container { max-width: 1800px; margin: 0 auto; padding: 0 1.5rem; }
            .flex { display: flex; } .inline-flex { display: inline-flex; } .flex-col { flex-direction: column; }
            .flex-wrap { flex-wrap: wrap; } .items-center { align-items: center; } .items-start { align-items: flex-start; }
            .justify-center { justify-content: center; } .justify-between { justify-content: space-between; }
            .gap-2 { gap: 0.5rem; } .gap-3 { gap: 0.75rem; } .gap-4 { gap: 1rem; } .gap-6 { gap: 1.5rem; }
            .flex-1 { flex: 1; } .flex-shrink-0 { flex-shrink: 0; }
            .grid { display: grid; }
            .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
            .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
            .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
            .grid-cols-6 { grid-template-columns: repeat(6, 1fr); }
            .w-full { width: 100%; } .h-full { height: 100%; } .min-h-screen { min-height: 100vh; }
            .m-4 { margin: 1rem; } .mt-2 { margin-top: 0.5rem; } .mt-4 { margin-top: 1rem; }
            .mb-2 { margin-bottom: 0.5rem; } .mb-4 { margin-bottom: 1rem; } .mb-6 { margin-bottom: 1.5rem; }
            .p-3 { padding: 0.75rem; } .p-4 { padding: 1rem; } .p-6 { padding: 1.5rem; }
            .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
            .overflow-hidden { overflow: hidden; } .overflow-y-auto { overflow-y: auto; }
            @media (min-width: 768px) {
                .md\:grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
                .md\:grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
                .md\:grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
                .md\:grid-cols-6 { grid-template-columns: repeat(6, 1fr); }
                .md\:flex-row { flex-direction: row; }
            }
        }
        @layer components {
            .glass-panel {
                background: var(--glass-bg); backdrop-filter: blur(24px);
                border: 1px solid var(--glass-border); border-radius: 16px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
                transition: all 0.4s var(--ease-out);
            }
            .glass-panel:hover { border-color: rgba(255,255,255,0.12); transform: translateY(-2px); }
            .btn {
                display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
                padding: 0.5rem 1rem; font-family: 'Orbitron', sans-serif; font-size: 0.65rem;
                font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase;
                border-radius: 8px; border: 1px solid transparent; cursor: pointer;
                transition: all 0.3s var(--ease-out); white-space: nowrap;
            }
            .btn-primary { background: linear-gradient(135deg, var(--neon-core), var(--accent-violet)); color: white; }
            .btn-primary:hover { box-shadow: 0 0 30px rgba(59, 130, 246, 0.4); }
            .btn-ghost { background: rgba(255, 255, 255, 0.03); color: var(--silver); border-color: var(--glass-border); }
            .btn-ghost:hover { background: rgba(255, 255, 255, 0.08); }
            .btn-warning { background: linear-gradient(135deg, var(--risk-high), #d97706); color: white; }
            .stat-card { position: relative; overflow: hidden; }
            .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; opacity: 0; transition: opacity 0.3s; }
            .stat-card:hover::before { opacity: 1; }
            .stat-card[data-risk="critical"]::before { background: var(--risk-critical); opacity: 1; }
            .stat-card[data-risk="high"]::before { background: var(--risk-high); opacity: 1; }
            .stat-card[data-risk="medium"]::before { background: var(--risk-medium); opacity: 1; }
            .badge {
                display: inline-flex; align-items: center; padding: 0.2rem 0.5rem;
                font-family: 'JetBrains Mono', monospace; font-size: 0.55rem; font-weight: 600;
                text-transform: uppercase; letter-spacing: 0.05em; border-radius: 99px; border: 1px solid;
            }
            .badge-critical { background: rgba(239, 68, 68, 0.15); color: var(--risk-critical); border-color: rgba(239, 68, 68, 0.3); }
            .badge-high { background: rgba(249, 115, 22, 0.15); color: var(--risk-high); border-color: rgba(249, 115, 22, 0.3); }
            .badge-medium { background: rgba(234, 179, 8, 0.15); color: var(--risk-medium); border-color: rgba(234, 179, 8, 0.3); }
            .badge-low { background: rgba(34, 197, 94, 0.15); color: var(--risk-low); border-color: rgba(34, 197, 94, 0.3); }
            .badge-person { background: rgba(59, 130, 246, 0.15); color: var(--neon-core); border-color: rgba(59, 130, 246, 0.3); }
            .badge-company { background: rgba(139, 92, 246, 0.15); color: var(--accent-violet); border-color: rgba(139, 92, 246, 0.3); }
            .badge-government { background: rgba(16, 185, 129, 0.15); color: var(--accent-emerald); border-color: rgba(16, 185, 129, 0.3); }
            .data-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.8rem; }
            .data-table th { text-align: left; padding: 0.75rem; color: var(--titanium); font-family: 'Orbitron'; font-size: 0.6rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; border-bottom: 1px solid var(--glass-border); background: rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 10; }
            .data-table td { padding: 0.625rem 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.03); font-family: 'JetBrains Mono'; font-size: 0.7rem; }
            .data-table tr:hover td { background: rgba(59, 130, 246, 0.05); }
            .data-table tr { cursor: pointer; }
            .network-container { position: relative; width: 100%; height: 650px; border-radius: 12px; overflow: hidden; background: radial-gradient(ellipse at center, var(--space-surface) 0%, var(--space-void) 100%); }
            .network-container svg { width: 100%; height: 100%; }
            .chart-container { position: relative; height: 240px; width: 100%; }
            .network-legend { position: absolute; bottom: 1rem; left: 1rem; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); border-radius: 10px; padding: 0.75rem; border: 1px solid var(--glass-border); z-index: 10; max-width: 180px; }
            .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.6rem; color: var(--titanium-light); margin-bottom: 0.25rem; }
            .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
            .legend-rect { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }
            .legend-line { width: 16px; height: 2px; flex-shrink: 0; }
            .network-controls { position: absolute; top: 1rem; right: 1rem; display: flex; flex-direction: column; gap: 0.5rem; z-index: 10; }
            .network-controls .btn { padding: 0.5rem; min-width: 32px; min-height: 32px; }
            .filter-chip { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.3rem 0.6rem; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 99px; font-size: 0.65rem; color: var(--titanium-light); cursor: pointer; transition: all 0.2s; }
            .filter-chip:hover { background: rgba(255,255,255,0.08); }
            .filter-chip.active { background: rgba(59, 130, 246, 0.15); border-color: rgba(59, 130, 246, 0.3); color: var(--neon-core); }
            .filter-chip-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
            .tabs { display: flex; gap: 0.25rem; border-bottom: 1px solid var(--glass-border); margin-bottom: 1rem; overflow-x: auto; }
            .tab { padding: 0.5rem 0.875rem; font-family: 'Orbitron'; font-size: 0.6rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--titanium); background: transparent; border: none; border-bottom: 2px solid transparent; margin-bottom: -1px; cursor: pointer; transition: all 0.3s; white-space: nowrap; }
            .tab:hover { color: var(--silver); }
            .tab.active { color: var(--neon-core); border-bottom-color: var(--neon-core); }
            .search-input { width: 100%; padding: 0.5rem 0.75rem 0.5rem 2rem; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--silver); font-family: 'Inter'; font-size: 0.75rem; transition: all 0.3s; }
            .search-input:focus { outline: none; border-color: var(--neon-core); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
            .search-wrapper { position: relative; }
            .search-icon { position: absolute; left: 0.625rem; top: 50%; transform: translateY(-50%); color: var(--titanium); pointer-events: none; }
            .tooltip { position: absolute; background: var(--space-void); border: 1px solid var(--glass-border); border-radius: 10px; padding: 0.75rem; font-size: 0.7rem; max-width: 300px; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 1000; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
            .tooltip.visible { opacity: 1; }
            .loader { width: 48px; height: 48px; border: 3px solid var(--glass-border); border-top-color: var(--peach-fuzz); border-radius: 50%; animation: spin 1s linear infinite; }
            .slide-panel { position: fixed; top: 0; right: 0; width: 100%; max-width: 500px; height: 100%; background: var(--space-deep); border-left: 1px solid var(--glass-border); transform: translateX(100%); transition: transform 0.5s var(--ease-out); z-index: 2000; overflow-y: auto; }
            .slide-panel.open { transform: translateX(0); }
            .slide-panel-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 1999; }
            .slide-panel-backdrop.open { opacity: 1; pointer-events: auto; }
            .risk-box { padding: 0.75rem; border-radius: 8px; border: 1px solid; }
            .risk-box-critical { background: rgba(239, 68, 68, 0.08); border-color: rgba(239, 68, 68, 0.25); }
            .risk-box-high { background: rgba(249, 115, 22, 0.08); border-color: rgba(249, 115, 22, 0.25); }
            .timeline-item { position: relative; padding-left: 1.5rem; padding-bottom: 1rem; border-left: 2px solid var(--glass-border); }
            .timeline-item:last-child { border-left-color: transparent; }
            .timeline-item::before { content: ''; position: absolute; left: -5px; top: 0; width: 8px; height: 8px; border-radius: 50%; background: var(--neon-core); }
            .timeline-item.risk::before { background: var(--risk-critical); box-shadow: 0 0 8px var(--risk-critical); }
            .procurement-card { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; border-left: 3px solid var(--neon-core); }
            .procurement-card.won { border-left-color: var(--accent-emerald); }
            .procurement-card.lost { border-left-color: var(--risk-high); }
            .procurement-card.risk { border-left-color: var(--risk-critical); }
        }
        @layer utilities {
            .font-display { font-family: 'Orbitron', sans-serif; }
            .font-mono { font-family: 'JetBrains Mono', monospace; }
            .text-xs { font-size: 0.75rem; } .text-sm { font-size: 0.875rem; } .text-base { font-size: 1rem; }
            .text-lg { font-size: 1.125rem; } .text-xl { font-size: 1.25rem; } .text-2xl { font-size: 1.5rem; }
            .font-medium { font-weight: 500; } .font-semibold { font-weight: 600; } .font-bold { font-weight: 700; }
            .tracking-wide { letter-spacing: 0.025em; } .tracking-wider { letter-spacing: 0.1em; }
            .uppercase { text-transform: uppercase; }
            .text-center { text-align: center; } .text-right { text-align: right; }
            .text-silver { color: var(--silver); } .text-muted { color: var(--titanium); }
            .text-neon { color: var(--neon-core); } .text-violet { color: var(--accent-violet); }
            .text-gold { color: var(--accent-gold); } .text-peach { color: var(--peach-fuzz); }
            .text-danger { color: var(--risk-critical); } .text-warning { color: var(--risk-high); }
            .text-emerald { color: var(--accent-emerald); }
            .border-glass { border-color: var(--glass-border); }
            .rounded-lg { border-radius: 12px; }
            .opacity-0 { opacity: 0; }
            .pointer-events-none { pointer-events: none; }
            .hidden { display: none !important; }
            .transition-opacity { transition: opacity 0.3s var(--ease-out); }
            .border-t { border-top: 1px solid var(--glass-border); }
            .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        }
        @layer animations {
            @keyframes spin { to { transform: rotate(360deg); } }
            @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
            .animate-spin { animation: spin 1s linear infinite; }
            .animate-pulse { animation: pulse 2s ease-in-out infinite; }
            .reveal { opacity: 0; transform: translateY(20px); transition: all 0.5s var(--ease-out); }
            .reveal.active { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body data-lang="en">
    <canvas id="antigravity-canvas" class="fixed inset-0 z-0"></canvas>
    <div class="fixed inset-0 z-0 pointer-events-none" style="background: radial-gradient(ellipse at 25% 15%, rgba(59, 130, 246, 0.04) 0%, transparent 45%), radial-gradient(ellipse at 75% 85%, rgba(139, 92, 246, 0.04) 0%, transparent 45%), radial-gradient(circle at center, transparent 0%, var(--space-void) 85%);"></div>
    <div id="loading-overlay" class="fixed inset-0 z-9999 flex flex-col items-center justify-center transition-opacity" style="background: var(--space-void);">
        <div class="loader mb-4"></div>
        <div class="font-display text-lg text-peach animate-pulse tracking-wider mb-2">
            <span lang="en">INITIALIZING NEXUS INTEL v12.0...</span>
            <span lang="th">กำลังเริ่มต้น NEXUS INTEL v12.0...</span>
        </div>
        <div class="text-xs text-muted font-mono">
            <span lang="en">Loading 42 entities, 85+ procurement records, 70+ connections</span>
            <span lang="th">โหลด 42 หน่วยงาน, 85+ รายการจัดซื้อ, 70+ การเชื่อมต่อ</span>
        </div>
    </div>
    <div class="relative z-10 min-h-screen">
        <header class="glass-panel m-4 p-4 sticky top-4 z-50">
            <div class="container flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div id="logo-slot" class="text-neon"></div>
                    <div>
                        <h1 class="font-display text-lg font-bold tracking-wider text-silver">NEXUS // <span class="text-gold">INTEL</span> <span class="text-xs text-muted font-mono">v12.0</span></h1>
                        <p class="text-xs text-muted tracking-wide">
                            <span lang="en">EXTENDED NETWORK • 42 ENTITIES • 85+ PROCUREMENTS • 70+ CONNECTIONS</span>
                            <span lang="th">เครือข่ายขยาย • 42 หน่วยงาน • 85+ จัดซื้อจัดจ้าง • 70+ การเชื่อมต่อ</span>
                        </p>
                    </div>
                </div>
                <nav class="flex items-center gap-2">
                    <button class="btn btn-ghost" onclick="APP.toggleLang()"><span id="icon-globe"></span> EN/TH</button>
                    <button class="btn btn-primary" onclick="APP.toggleHelp()"><span id="icon-help"></span></button>
                </nav>
            </div>
        </header>
        <main class="container py-6">
            <section class="mb-6 reveal">
                <div class="flex flex-col md:flex-row justify-between items-start gap-4 mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2 flex-wrap">
                            <span class="badge badge-critical"><span lang="en">CRITICAL</span><span lang="th">วิกฤต</span></span>
                            <span class="badge badge-person"><span lang="en">CENTRAL FIGURE</span><span lang="th">บุคคลสำคัญ</span></span>
                        </div>
                        <h2 class="font-display text-2xl font-bold tracking-wide text-silver mb-1">นายปฏิกร พิทักษ์ฉนวน</h2>
                        <p class="text-muted text-sm"><span lang="en">Extended Network Investigation • Pram Group & Procurement Ring</span><span lang="th">การสืบสวนเครือข่ายขยาย • เปรม กรุ๊ป และวงจรจัดซื้อจัดจ้าง</span></p>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button class="btn btn-ghost" onclick="APP.resetNetwork()"><span id="icon-reset"></span> <span lang="en">RESET</span><span lang="th">รีเซ็ต</span></button>
                        <button class="btn btn-warning" onclick="APP.highlightCollusion()"><span id="icon-alert"></span> <span lang="en">COLLUSION</span><span lang="th">สมคบคิด</span></button>
                        <button class="btn btn-primary" onclick="APP.highlightBridges()"><span id="icon-bridge"></span> <span lang="en">KEY LINKS</span><span lang="th">จุดเชื่อมสำคัญ</span></button>
                    </div>
                </div>
            </section>
            <section class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-6 reveal">
                <div class="glass-panel stat-card p-3" data-risk="critical">
                    <div class="text-xs text-muted tracking-wider font-display uppercase mb-1"><span lang="en">Entities</span><span lang="th">หน่วยงาน</span></div>
                    <div class="text-2xl font-display font-bold text-silver" id="stat-entities">42</div>
                    <div class="text-xs text-muted"><span lang="en">Total Nodes</span><span lang="th">โหนดทั้งหมด</span></div>
                </div>
                <div class="glass-panel stat-card p-3" data-risk="high">
                    <div class="text-xs text-muted tracking-wider font-display uppercase mb-1"><span lang="en">Links</span><span lang="th">เชื่อมโยง</span></div>
                    <div class="text-2xl font-display font-bold text-silver" id="stat-connections">70+</div>
                    <div class="text-xs text-muted"><span lang="en">Relationships</span><span lang="th">ความสัมพันธ์</span></div>
                </div>
                <div class="glass-panel stat-card p-3" data-risk="critical">
                    <div class="text-xs text-muted tracking-wider font-display uppercase mb-1"><span lang="en">Collusion</span><span lang="th">สมคบคิด</span></div>
                    <div class="text-2xl font-display font-bold text-danger" id="stat-collusion">15</div>
                    <div class="text-xs text-muted"><span lang="en">Risk Links</span><span lang="th">ลิงก์เสี่ยง</span></div>
                </div>
                <div class="glass-panel stat-card p-3" data-risk="medium">
                    <div class="text-xs text-muted tracking-wider font-display uppercase mb-1"><span lang="en">Gov Clients</span><span lang="th">ลูกค้ารัฐ</span></div>
                    <div class="text-2xl font-display font-bold text-emerald" id="stat-gov">5</div>
                    <div class="text-xs text-muted"><span lang="en">Agencies</span><span lang="th">หน่วยงาน</span></div>
                </div>
                <div class="glass-panel stat-card p-3" data-risk="high">
                    <div class="text-xs text-muted tracking-wider font-display uppercase mb-1"><span lang="en">Procurements</span><span lang="th">จัดซื้อจัดจ้าง</span></div>
                    <div class="text-2xl font-display font-bold text-warning" id="stat-procurements">85+</div>
                    <div class="text-xs text-muted"><span lang="en">Records</span><span lang="th">รายการ</span></div>
                </div>
                <div class="glass-panel stat-card p-3" data-risk="critical">
                    <div class="text-xs text-muted tracking-wider font-display uppercase mb-1"><span lang="en">Contracts</span><span lang="th">สัญญา</span></div>
                    <div class="text-xl font-display font-bold text-danger" id="stat-contracts">1.87B+</div>
                    <div class="text-xs text-muted"><span lang="en">THB Total</span><span lang="th">บาทรวม</span></div>
                </div>
            </section>
            <section class="glass-panel p-4 mb-6 reveal">
                <div class="flex flex-col md:flex-row justify-between items-start gap-3 mb-4">
                    <div>
                        <h3 class="font-display text-base font-bold tracking-wide text-silver mb-1"><span lang="en">NETWORK TOPOLOGY (42 Nodes)</span><span lang="th">โครงสร้างเครือข่าย (42 โหนด)</span></h3>
                        <p class="text-xs text-muted"><span lang="en">Click nodes for details • Drag to move • Scroll to zoom</span><span lang="th">คลิกโหนดดูรายละเอียด • ลากเพื่อย้าย • เลื่อนเพื่อซูม</span></p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <div class="filter-chip active" data-filter="all" onclick="APP.filterNetwork('all')"><span lang="en">All</span><span lang="th">ทั้งหมด</span></div>
                        <div class="filter-chip" data-filter="person" onclick="APP.filterNetwork('person')"><span class="filter-chip-dot" style="background: var(--neon-core);"></span> <span lang="en">Person</span><span lang="th">บุคคล</span></div>
                        <div class="filter-chip" data-filter="company" onclick="APP.filterNetwork('company')"><span class="filter-chip-dot" style="background: var(--accent-violet);"></span> <span lang="en">Company</span><span lang="th">บริษัท</span></div>
                        <div class="filter-chip" data-filter="government" onclick="APP.filterNetwork('government')"><span class="filter-chip-dot" style="background: var(--accent-emerald);"></span> <span lang="en">Gov</span><span lang="th">รัฐ</span></div>
                        <div class="filter-chip" data-filter="critical" onclick="APP.filterNetwork('critical')"><span class="filter-chip-dot" style="background: var(--risk-critical);"></span> <span lang="en">Critical</span><span lang="th">วิกฤต</span></div>
                    </div>
                </div>
                <div class="network-container" id="network-container">
                    <svg id="network-svg"></svg>
                    <div class="network-legend">
                        <div class="text-xs font-display tracking-wider text-muted mb-2 uppercase"><span lang="en">Legend</span><span lang="th">คำอธิบาย</span></div>
                        <div class="legend-item"><span class="legend-dot" style="background: var(--neon-core);"></span> <span lang="en">Person</span><span lang="th">บุคคล</span></div>
                        <div class="legend-item"><span class="legend-rect" style="background: var(--accent-violet);"></span> <span lang="en">Company</span><span lang="th">บริษัท</span></div>
                        <div class="legend-item"><span class="legend-dot" style="background: var(--accent-emerald); border: 2px solid white;"></span> <span lang="en">Government</span><span lang="th">หน่วยงานรัฐ</span></div>
                        <div class="legend-item"><span class="legend-dot" style="background: var(--risk-critical); box-shadow: 0 0 6px var(--risk-critical);"></span> <span lang="en">Critical</span><span lang="th">วิกฤต</span></div>
                        <div class="legend-item"><span class="legend-line" style="background: rgba(59,130,246,0.6);"></span> <span lang="en">Direct</span><span lang="th">ตรง</span></div>
                        <div class="legend-item"><span class="legend-line" style="background: repeating-linear-gradient(90deg, rgba(139,92,246,0.5) 0 3px, transparent 3px 6px);"></span> <span lang="en">Historical</span><span lang="th">อดีต</span></div>
                        <div class="legend-item"><span class="legend-line" style="background: rgba(239,68,68,0.6);"></span> <span lang="en">Collusion</span><span lang="th">สมคบคิด</span></div>
                    </div>
                    <div class="network-controls">
                        <button class="btn btn-ghost" onclick="APP.zoomIn()" title="Zoom In"><span id="icon-zoom-in"></span></button>
                        <button class="btn btn-ghost" onclick="APP.zoomOut()" title="Zoom Out"><span id="icon-zoom-out"></span></button>
                        <button class="btn btn-ghost" onclick="APP.centerNetwork()" title="Center"><span id="icon-center"></span></button>
                    </div>
                </div>
            </section>
            <section class="grid md:grid-cols-3 gap-4 mb-6">
                <div class="glass-panel p-4 reveal">
                    <h3 class="font-display text-sm font-bold tracking-wider text-silver mb-3 uppercase"><span lang="en">Risk Matrix</span><span lang="th">เมทริกซ์ความเสี่ยง</span></h3>
                    <div class="chart-container"><canvas id="radarChart"></canvas></div>
                </div>
                <div class="glass-panel p-4 reveal">
                    <h3 class="font-display text-sm font-bold tracking-wider text-silver mb-3 uppercase"><span lang="en">Entity Types</span><span lang="th">ประเภทหน่วยงาน</span></h3>
                    <div class="chart-container"><canvas id="doughnutChart"></canvas></div>
                </div>
                <div class="glass-panel p-4 reveal">
                    <h3 class="font-display text-sm font-bold tracking-wider text-silver mb-3 uppercase"><span lang="en">Risk Levels</span><span lang="th">ระดับความเสี่ยง</span></h3>
                    <div class="chart-container"><canvas id="barChart"></canvas></div>
                </div>
            </section>
            <!-- NEW: Procurement Timeline Section -->
            <section class="glass-panel p-4 mb-6 reveal">
                <div class="flex flex-col md:flex-row justify-between items-start gap-3 mb-4">
                    <div>
                        <h3 class="font-display text-base font-bold tracking-wide text-silver mb-1"><span lang="en">PROCUREMENT TIMELINE (85+ Records)</span><span lang="th">ไทม์ไลน์จัดซื้อจัดจ้าง (85+ รายการ)</span></h3>
                        <p class="text-xs text-muted"><span lang="en">Key contracts involving Pram Group & Systronics</span><span lang="th">สัญญาสำคัญที่เกี่ยวข้องกับ Pram Group และ Systronics</span></p>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-ghost" onclick="APP.showProcurementTab('all')"><span lang="en">All</span><span lang="th">ทั้งหมด</span></button>
                        <button class="btn btn-ghost" onclick="APP.showProcurementTab('risk')"><span lang="en">Risk Only</span><span lang="th">เสี่ยงเท่านั้น</span></button>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <div class="text-xs text-muted uppercase tracking-wider font-display mb-3"><span lang="en">Major Contracts (Pram Group)</span><span lang="th">สัญญาหลัก (Pram Group)</span></div>
                        <div id="procurement-pram" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    <div>
                        <div class="text-xs text-muted uppercase tracking-wider font-display mb-3"><span lang="en">Co-Bidding Patterns</span><span lang="th">รูปแบบการประมูลร่วม</span></div>
                        <div id="procurement-cobid" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </section>
            <section class="glass-panel p-4 mb-6 reveal">
                <div class="flex flex-col md:flex-row justify-between items-start gap-3 mb-4">
                    <div>
                        <h3 class="font-display text-base font-bold tracking-wide text-silver mb-1"><span lang="en">CLUSTER ANALYSIS</span><span lang="th">การวิเคราะห์กลุ่ม</span></h3>
                        <p class="text-xs text-muted"><span lang="en">Collusion patterns and procurement rings</span><span lang="th">รูปแบบการสมคบคิดและวงจรจัดซื้อจัดจ้าง</span></p>
                    </div>
                </div>
                <div class="tabs">
                    <button class="tab active" data-tab="central" onclick="APP.showCluster('central')"><span lang="en">Central</span><span lang="th">ศูนย์กลาง</span></button>
                    <button class="tab" data-tab="phoenix" onclick="APP.showCluster('phoenix')"><span lang="en">Phoenix-Prem</span><span lang="th">ฟีนิกซ์-เปรม</span></button>
                    <button class="tab" data-tab="systronics" onclick="APP.showCluster('systronics')"><span lang="en">Systronics</span><span lang="th">ซิสทรอนิกส์</span></button>
                    <button class="tab" data-tab="cctv" onclick="APP.showCluster('cctv')"><span lang="en">CCTV Ring</span><span lang="th">วงจร CCTV</span></button>
                    <button class="tab" data-tab="support" onclick="APP.showCluster('support')"><span lang="en">Support Bidders</span><span lang="th">ผู้สนับสนุน</span></button>
                </div>
                <div id="cluster-content"></div>
            </section>
            <section class="glass-panel p-4 mb-6 reveal">
                <div class="flex flex-col md:flex-row justify-between items-start gap-3 mb-4">
                    <div>
                        <h3 class="font-display text-base font-bold tracking-wide text-silver mb-1"><span lang="en">ENTITY REGISTRY (42)</span><span lang="th">ทะเบียนหน่วยงาน (42)</span></h3>
                        <p class="text-xs text-muted"><span lang="en">Click row for details</span><span lang="th">คลิกแถวเพื่อดูรายละเอียด</span></p>
                    </div>
                    <div class="search-wrapper" style="width: 240px;">
                        <span class="search-icon" id="icon-search"></span>
                        <input type="text" class="search-input" id="entity-search" placeholder="Search..." oninput="APP.searchEntities(this.value)">
                    </div>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="data-table" id="entity-table">
                        <thead><tr><th style="width:40%;"><span lang="en">Entity</span><span lang="th">หน่วยงาน</span></th><th><span lang="en">Type</span><span lang="th">ประเภท</span></th><th><span lang="en">Risk</span><span lang="th">ความเสี่ยง</span></th><th><span lang="en">Category</span><span lang="th">หมวด</span></th></tr></thead>
                        <tbody id="entity-table-body"></tbody>
                    </table>
                </div>
            </section>
            <section class="glass-panel p-4 mb-6 reveal" style="border-color: rgba(239, 68, 68, 0.4);">
                <h3 class="font-display text-base font-bold tracking-wide text-danger mb-4"><span lang="en">⚠ CRITICAL FINDINGS</span><span lang="th">⚠ ข้อค้นพบสำคัญ</span></h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="risk-box risk-box-critical">
                        <div class="text-xs text-muted uppercase tracking-wider mb-2 font-display"><span lang="en">#1: Pram-Systronics Reciprocal Bidding</span><span lang="th">#1: การประมูลสลับกัน Pram-Systronics</span></div>
                        <p class="text-sm text-silver"><span lang="en">Price clustering in <strong class="text-danger">28+ projects</strong>. Alternating winners pattern. Connected via <strong class="text-gold">Kriangsak Imsri</strong> through Krungthep Brew House.</span><span lang="th">ราคาเกาะกลุ่มใน <strong class="text-danger">28+ โครงการ</strong> รูปแบบผู้ชนะสลับกัน เชื่อมต่อผ่าน <strong class="text-gold">เกรียงศักดิ์ อิ่มศรี</strong> ทางกรุงเทพ บริว เฮาส์</span></p>
                    </div>
                    <div class="risk-box risk-box-critical">
                        <div class="text-xs text-muted uppercase tracking-wider mb-2 font-display"><span lang="en">#2: K Technology - 100% Loss Pattern</span><span lang="th">#2: K Technology - รูปแบบแพ้ 100%</span></div>
                        <p class="text-sm text-silver"><span lang="en"><strong class="text-warning">K Technology</strong> lost <strong class="text-danger">100% of 9 bids</strong> against Pram. Connected via Phoenix → Suwanee → Jeerapong chain.</span><span lang="th"><strong class="text-warning">K Technology</strong> แพ้ <strong class="text-danger">100% จาก 9 ครั้ง</strong> กับ Pram เชื่อมต่อผ่านห่วงโซ่ Phoenix → สุวรรณี → จีรพงษ์</span></p>
                    </div>
                    <div class="risk-box risk-box-high">
                        <div class="text-xs text-muted uppercase tracking-wider mb-2 font-display"><span lang="en">#3: BKK CCTV Three-Way Clustering</span><span lang="th">#3: ราคาเกาะกลุ่ม 3 ทาง CCTV กทม.</span></div>
                        <p class="text-sm text-silver"><span lang="en">Genius (88.6M), Vision (88.87M), Systronics (88.86M). Price diff <strong class="text-danger"><0.3%</strong> - statistically improbable.</span><span lang="th">Genius (88.6M), Vision (88.87M), Systronics (88.86M) ราคาต่าง <strong class="text-danger"><0.3%</strong> - ไม่น่าจะเป็นไปได้ทางสถิติ</span></p>
                    </div>
                    <div class="risk-box risk-box-high">
                        <div class="text-xs text-muted uppercase tracking-wider mb-2 font-display"><span lang="en">#4: Sole-Source End-of-Year Contracts</span><span lang="th">#4: สัญญาเฉพาะเจาะจงท้ายปีงบประมาณ</span></div>
                        <p class="text-sm text-silver"><span lang="en">Multiple <strong class="text-warning">sole-source contracts</strong> awarded to Pram Group at fiscal year-end (Sep-Oct). Total: <strong class="text-danger">97.57M THB</strong> in FY2567 alone.</span><span lang="th">หลาย <strong class="text-warning">สัญญาเฉพาะเจาะจง</strong> ให้ Pram Group ท้ายปีงบประมาณ (ก.ย.-ต.ค.) รวม: <strong class="text-danger">97.57 ล้านบาท</strong> ในปี 2567</span></p>
                    </div>
                    <div class="risk-box risk-box-high">
                        <div class="text-xs text-muted uppercase tracking-wider mb-2 font-display"><span lang="en">#5: Prem Engineering Name Legacy</span><span lang="th">#5: มรดกชื่อเปรม เอ็นจิเนียริ่ง</span></div>
                        <p class="text-sm text-silver"><span lang="en">Phonetic: "<strong class="text-gold">Pram</strong>" vs dissolved "<strong class="text-gold">Prem</strong>". Partnership links Suwanee → Jeerapong → K Tech.</span><span lang="th">เสียงคล้าย: "<strong class="text-gold">เปรม กรุ๊ป</strong>" vs "<strong class="text-gold">เปรม เอ็นจิเนียริ่ง</strong>" ที่เลิก ห้างหุ้นส่วนเชื่อม สุวรรณี → จีรพงษ์ → K Tech</span></p>
                    </div>
                    <div class="risk-box risk-box-critical">
                        <div class="text-xs text-muted uppercase tracking-wider mb-2 font-display"><span lang="en">#6: Contract Inflation Pattern</span><span lang="th">#6: รูปแบบสัญญาสูงกว่าราคาประมูล</span></div>
                        <p class="text-sm text-silver"><span lang="en">Multiple projects show <strong class="text-danger">contract value higher than winning bid</strong>. Detected in SEC, Excise Dept projects.</span><span lang="th">หลายโครงการแสดง <strong class="text-danger">มูลค่าสัญญาสูงกว่าราคาประมูลชนะ</strong> พบในโครงการ ก.ล.ต., กรมสรรพสามิต</span></p>
                    </div>
                </div>
            </section>
            <footer class="text-center py-6 border-t border-glass">
                <p class="text-xs text-muted"><span lang="en">NEXUS INTEL v12.0 • GraphML Extended • 85+ Procurement Records • For Investigation Only</span><span lang="th">NEXUS INTEL v12.0 • GraphML ขยาย • 85+ รายการจัดซื้อ • เพื่อการสืบสวนเท่านั้น</span></p>
                <p class="text-xs text-danger mt-2 font-display tracking-wider">⚠ <span lang="en">NOT FOR PUBLIC DISTRIBUTION</span><span lang="th">ห้ามเผยแพร่สู่สาธารณะ</span></p>
            </footer>
        </main>
    </div>
    <div id="panel-backdrop" class="slide-panel-backdrop" onclick="APP.closePanel()"></div>
    <aside id="slide-panel" class="slide-panel">
        <div class="p-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <div class="text-xs text-muted uppercase tracking-widest font-display mb-1"><span lang="en">Entity Profile</span><span lang="th">โปรไฟล์</span></div>
                    <h3 class="font-display text-lg font-bold text-silver" id="panel-title">--</h3>
                </div>
                <button class="btn btn-ghost" onclick="APP.closePanel()"><span id="icon-close"></span></button>
            </div>
            <div id="panel-content"></div>
        </div>
    </aside>
    <div id="tooltip" class="tooltip"></div>
    <script>
        // ICONS (Native SVG - No FontAwesome)
        const ICONS = {
            logo: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:28px;height:28px"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>`,
            globe: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>`,
            help: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
            reset: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>`,
            alert: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
            bridge: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M3 21h18"/><path d="M5 21V7l7-4 7 4v14"/></svg>`,
            search: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>`,
            close: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
            zoomIn: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>`,
            zoomOut: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>`,
            center: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><circle cx="12" cy="12" r="3"/><path d="M12 2v4"/><path d="M12 18v4"/><path d="M2 12h4"/><path d="M18 12h4"/></svg>`,
            arrow: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>`
        };

        // COMPLETE GRAPHML DATA (42 Nodes) - CORRECTED
        const graphData = {
            nodes: [
                {id:"n1",label:"นายปฏิกร พิทักษ์ฉนวน",type:"Person",risk:"Critical",category:"Central_Figure"},
                {id:"n2",label:"บริษัท เปรม กรุ๊ป เอ็นจิเนียริ่ง จำกัด",type:"Company",risk:"Critical",category:"Central_Hub"},
                {id:"n3",label:"นายพีรพล จันทร์ขำ",type:"Person",risk:"High",category:"Executive"},
                {id:"n4",label:"นายธนเทพ พิทักษ์ฉนวน",type:"Person",risk:"Medium",category:"Family_Member"},
                {id:"n5",label:"บริษัท ฟีนิกซ์ คอร์ปเอเซีย จำกัด",type:"Company",risk:"Medium",category:"Affiliated_Entity"},
                {id:"n6",label:"นางสาวสุวรรณี อยู่นิรันดร",type:"Person",risk:"High",category:"Key_Connector"},
                {id:"n7",label:"ห้างหุ้นส่วนจำกัด เปรม เอ็นจิเนียริ่ง",type:"Company",risk:"High",category:"Dissolved_Entity"},
                {id:"n8",label:"นายจีรพงษ์ ใจหลัก",type:"Person",risk:"High",category:"Key_Connector"},
                {id:"n9",label:"บริษัท เค เทคโนโลยี โซลูชั่น จำกัด",type:"Company",risk:"High",category:"Support_Bidder"},
                {id:"n10",label:"บริษัท กรุงเทพบริวเฮาส์ จำกัด",type:"Company",risk:"Medium",category:"Affiliated_Entity"},
                {id:"n11",label:"นายเกรียงศักดิ์ อิ่มศรี",type:"Person",risk:"High",category:"Key_Connector"},
                {id:"n12",label:"บริษัท ซิสทรอนิกส์ จำกัด",type:"Company",risk:"Critical",category:"Procurement_Ring_Member"},
                {id:"n13",label:"นายอัศวรรณ์ เรืองชู",type:"Person",risk:"Medium",category:"Shareholder"},
                {id:"n14",label:"นายจิรวัฒน์ บุญวัฒนโสภณ",type:"Person",risk:"Low",category:"Shareholder"},
                {id:"n15",label:"บริษัท บริการภาคพื้น ดีพีเอส จำกัด",type:"Company",risk:"Medium",category:"Affiliated_Entity"},
                {id:"n16",label:"บริษัท แดนไทย อีควิปเม้นท์ จำกัด",type:"Company",risk:"Medium",category:"Affiliated_Entity"},
                {id:"n17",label:"นายศาศวัต เด่นแดนโดม",type:"Person",risk:"Medium",category:"Director"},
                {id:"n18",label:"นายลือชา การณ์เมือง",type:"Person",risk:"Low",category:"Director"},
                {id:"n19",label:"บริษัท เฟเวอร์ริท เทคโนโลยี จำกัด",type:"Company",risk:"Medium",category:"Affiliated_Entity"},
                {id:"n20",label:"นายนุชา มนตรีเศวตกุล",type:"Person",risk:"Medium",category:"Director"},
                {id:"n21",label:"นางนุจนาจ รุมเมิล-อีริคเซ่น",type:"Person",risk:"Medium",category:"Major_Shareholder"},
                {id:"n22",label:"นางสาววชิราพรรณ อารมณ์ชื่น",type:"Person",risk:"Low",category:"Shareholder"},
                {id:"n23",label:"บริษัท เอ็กซ์เปิร์ท เอ็นจิเนียริ่ง แอนด์ คอมมูนิเคชั่น จำกัด",type:"Company",risk:"High",category:"Support_Bidder"},
                {id:"n24",label:"บริษัท ไอ-ทรี ครีเอชั่น จำกัด",type:"Company",risk:"Medium",category:"Validator"},
                {id:"n25",label:"บริษัท ทีเอ ซิสเต็มส์ (ประเทศไทย) จำกัด",type:"Company",risk:"Medium",category:"Validator"},
                {id:"n26",label:"บริษัท จีเนียส ทราฟฟิค ซีสเต็ม จำกัด",type:"Company",risk:"High",category:"Procurement_Competitor"},
                {id:"n27",label:"บริษัท วิชั่น แอนด์ ซีเคียวริตี้ ซีสเต็ม จำกัด",type:"Company",risk:"High",category:"Procurement_Competitor"},
                {id:"n28",label:"บริษัท บีทามส์ โซลูชั่น จำกัด",type:"Company",risk:"Medium",category:"IT_Vendor"},
                {id:"n29",label:"บริษัท เน็ตเซอร์พลัส จำกัด",type:"Company",risk:"Medium",category:"IT_Vendor"},
                {id:"n30",label:"บริษัท ไคเนติคส์ คอร์ปอเรชั่น จำกัด",type:"Company",risk:"High",category:"Procurement_Competitor"},
                {id:"n31",label:"บริษัท ที เอช พี ซี จำกัด",type:"Company",risk:"Medium",category:"Procurement_Competitor"},
                {id:"n32",label:"บริษัท ทีซีเอ็ม เทคโนโลยี จำกัด",type:"Company",risk:"Medium",category:"Education_Vendor"},
                {id:"n33",label:"บริษัท เอสโซ่ (ประเทศไทย) จำกัด (มหาชน)",type:"Company",risk:"Low",category:"Client_Entity"},
                {id:"n34",label:"บริษัท บางจาก คอร์ปอเรชั่น จำกัด (มหาชน)",type:"Company",risk:"Low",category:"Client_Entity"},
                {id:"n35",label:"บริษัท พีทีที โกลบอล เคมิคอล จำกัด (มหาชน)",type:"Company",risk:"Low",category:"Client_Entity"},
                {id:"n36",label:"บริษัท สตาร์ ปิโตรเลียม รีไฟน์นิ่ง จำกัด (มหาชน)",type:"Company",risk:"Low",category:"Client_Entity"},
                {id:"n37",label:"กรมสรรพสามิต",type:"Government",risk:"Low",category:"Procurement_Client"},
                {id:"n38",label:"กรุงเทพมหานคร",type:"Government",risk:"Low",category:"Procurement_Client"},
                // CORRECTED: Full name from GraphML
                {id:"n39",label:"สำนักงานคณะกรรมการกำกับหลักทรัพย์และตลาดหลักทรัพย์",type:"Government",risk:"Low",category:"Procurement_Client"},
                {id:"n40",label:"สำนักงานปลัดกระทรวงมหาดไทย",type:"Government",risk:"Low",category:"Procurement_Client"},
                {id:"n41",label:"กรมทางหลวงชนบท",type:"Government",risk:"Low",category:"Procurement_Client"},
                {id:"n42",label:"บริษัท โปรเอ็น คอร์ป จำกัด (มหาชน)",type:"Company",risk:"Medium",category:"IT_Vendor"}
            ],
            links: [
                // OWNERSHIP & DIRECTORSHIP
                {source:"n1",target:"n2",rel:"Shareholder",details:"97.8% Ownership - Majority Control",type:"solid",riskIndicator:"Critical_Control"},
                {source:"n1",target:"n5",rel:"Former_Director",details:"Resigned 2023 - Historical Connection",type:"dashed",riskIndicator:"Historical_Link"},
                {source:"n1",target:"n10",rel:"Shareholder_Director",details:"50% Ownership - Joint Control",type:"solid",riskIndicator:"Significant_Control"},
                {source:"n1",target:"n15",rel:"Shareholder_Director",details:"1% Ownership - Board Influence",type:"solid",riskIndicator:"Minor_Stake"},
                {source:"n1",target:"n11",rel:"Business_Associate",details:"Joint Directorship in Krungthep Brew House",type:"hidden",riskIndicator:"Hidden_Connection"},
                {source:"n3",target:"n2",rel:"CEO",details:"Current CEO / 0.1% Shareholder - Executive Control",type:"solid",riskIndicator:"Executive_Control"},
                {source:"n4",target:"n2",rel:"Shareholder",details:"2.1% Ownership - Family Stake",type:"solid",riskIndicator:"Family_Connection"},
                {source:"n2",target:"n15",rel:"Shareholder",details:"29% Ownership in DPS Ground Services",type:"solid",riskIndicator:"Significant_Investment"},
                {source:"n2",target:"n19",rel:"Shareholder",details:"25% Ownership in Favorite Technology",type:"solid",riskIndicator:"Significant_Investment"},
                {source:"n3",target:"n5",rel:"Shareholder",details:"2% Ownership - Cross-Company Link",type:"solid",riskIndicator:"Cross_Ownership"},
                {source:"n6",target:"n5",rel:"Shareholder_Director",details:"98% Ownership - Majority Control",type:"solid",riskIndicator:"Critical_Control"},
                {source:"n6",target:"n7",rel:"Partner",details:"50% Equity in Dissolved Partnership",type:"dashed",riskIndicator:"Historical_Link"},
                {source:"n8",target:"n7",rel:"Partner",details:"50% Equity in Dissolved Partnership",type:"dashed",riskIndicator:"Historical_Link"},
                {source:"n8",target:"n9",rel:"Director_Shareholder",details:"Controls K Technology Solution",type:"solid",riskIndicator:"Critical_Control"},
                {source:"n6",target:"n8",rel:"Former_Partner",details:"Co-Partners in Dissolved Prem Engineering",type:"dashed",riskIndicator:"Historical_Connection"},
                {source:"n3",target:"n6",rel:"Business_Associate",details:"Connected via Phoenix Corp Asia shareholding",type:"hidden",riskIndicator:"Indirect_Connection"},
                {source:"n6",target:"n9",rel:"Indirect_Control",details:"Suwanee connected to K Tech via Jeerapong",type:"hidden",riskIndicator:"Hidden_Connection"},
                {source:"n11",target:"n10",rel:"Shareholder_Director",details:"25% Ownership in Krungthep Brew House",type:"solid",riskIndicator:"Significant_Control"},
                {source:"n11",target:"n12",rel:"Shareholder_Director",details:"50% Ownership in Systronics",type:"solid",riskIndicator:"Critical_Control"},
                {source:"n13",target:"n12",rel:"Shareholder_Director",details:"42% Ownership in Systronics",type:"solid",riskIndicator:"Significant_Control"},
                {source:"n14",target:"n12",rel:"Shareholder",details:"8% Ownership in Systronics",type:"solid",riskIndicator:"Minor_Stake"},
                {source:"n20",target:"n19",rel:"Director",details:"นุชา มนตรีเศวตกุล - Director",type:"solid",riskIndicator:"Board_Position"},
                {source:"n21",target:"n19",rel:"Shareholder_Director",details:"65% Ownership - Majority Control",type:"solid",riskIndicator:"Critical_Control"},
                {source:"n22",target:"n19",rel:"Shareholder_Director",details:"10% Ownership",type:"solid",riskIndicator:"Minor_Stake"},
                {source:"n16",target:"n15",rel:"Major_Shareholder",details:"49% Ownership - Near Majority",type:"solid",riskIndicator:"Significant_Control"},
                {source:"n17",target:"n15",rel:"Director_Shareholder",details:"6% Ownership",type:"solid",riskIndicator:"Minor_Stake"},
                {source:"n18",target:"n15",rel:"Director",details:"Board Member",type:"solid",riskIndicator:"Board_Position"},
                
                // PROCUREMENT COLLUSION PATTERNS
                {source:"n2",target:"n12",rel:"Procurement_Collusion_Risk",details:"Price Clustering/Shared Bids in 28+ Projects - CCTV and Traffic Systems",type:"risk",riskIndicator:"Critical_Risk"},
                {source:"n12",target:"n2",rel:"Procurement_Collusion_Risk",details:"Reciprocal Bidding Pattern - Alternating Winners",type:"risk",riskIndicator:"Critical_Risk"},
                {source:"n9",target:"n2",rel:"Procurement_Support_Bidder",details:"K Tech lost 100% of bids against Pram (9 Projects) - Suspicious Pattern",type:"risk",riskIndicator:"High_Risk"},
                {source:"n23",target:"n2",rel:"Procurement_Support_Bidder",details:"Expert Eng lost 100% of bids against Pram (6 Projects)",type:"risk",riskIndicator:"High_Risk"},
                {source:"n24",target:"n2",rel:"Bid_Validator",details:"I-3 Creation bids alongside Pram - Legitimizing Presence",type:"dashed",riskIndicator:"Medium_Risk"},
                {source:"n25",target:"n2",rel:"Bid_Validator",details:"TA System bids alongside Pram - Legitimizing Presence",type:"dashed",riskIndicator:"Medium_Risk"},
                
                // CCTV/TRAFFIC RING
                {source:"n12",target:"n26",rel:"Procurement_Competitor",details:"Competed in BKK CCTV Project - Price Clustering Detected",type:"risk",riskIndicator:"High_Risk"},
                {source:"n12",target:"n27",rel:"Procurement_Competitor",details:"Competed in BKK CCTV Project - Close Price Margins",type:"risk",riskIndicator:"High_Risk"},
                {source:"n26",target:"n27",rel:"Procurement_Price_Clustering",details:"Price difference less than 0.3% in multiple bids",type:"risk",riskIndicator:"Critical_Risk"},
                {source:"n26",target:"n38",rel:"Procurement_Winner",details:"Won BKK CCTV Maintenance Contract - 88.6M THB",type:"solid",riskIndicator:"Contract_Award"},
                {source:"n27",target:"n38",rel:"Procurement_Bidder",details:"Bid 88.87M THB - Lost by narrow margin",type:"dashed",riskIndicator:"Close_Bid"},
                {source:"n12",target:"n38",rel:"Procurement_Bidder",details:"Bid 88.86M THB - Third place",type:"dashed",riskIndicator:"Close_Bid"},
                
                // INNOVATION CLUSTER
                {source:"n30",target:"n23",rel:"Procurement_Competitor",details:"Environmental Innovation Center - Price Clustering",type:"risk",riskIndicator:"High_Risk"},
                {source:"n30",target:"n31",rel:"Procurement_Price_Clustering",details:"Bid prices within 0.2% range - Suspicious Pattern",type:"risk",riskIndicator:"High_Risk"},
                {source:"n23",target:"n31",rel:"Procurement_Price_Clustering",details:"Three-way price clustering detected",type:"risk",riskIndicator:"High_Risk"},
                
                // SEC/MOI CONTRACTS
                {source:"n28",target:"n39",rel:"Procurement_Winner",details:"Won SEC Visualization Software - Multiple Years",type:"solid",riskIndicator:"Repeat_Winner"},
                {source:"n29",target:"n39",rel:"Procurement_Bidder",details:"Lost to BEtimes despite lower price - Suspicious",type:"risk",riskIndicator:"High_Risk"},
                {source:"n28",target:"n29",rel:"Procurement_Collusion_Risk",details:"Winner selected despite higher price - Abnormal Pattern",type:"risk",riskIndicator:"Critical_Risk"},
                {source:"n28",target:"n40",rel:"Procurement_Winner",details:"Won MOI Contract - 300K THB",type:"solid",riskIndicator:"Contract_Award"},
                
                // EXCISE DEPARTMENT
                {source:"n2",target:"n37",rel:"Procurement_Winner",details:"Won Excise Dept Electronic System - 28M THB",type:"solid",riskIndicator:"Major_Contract"},
                {source:"n12",target:"n37",rel:"Procurement_Bidder",details:"Bid on Excise Oil Monitoring System - 53.62M THB",type:"dashed",riskIndicator:"Close_Bid"},
                
                // OIL/ENERGY CLIENTS
                {source:"n2",target:"n33",rel:"Project_Client",details:"Oil Monitoring System Installation - Esso Thailand",type:"solid",riskIndicator:"Client_Relationship"},
                {source:"n2",target:"n34",rel:"Project_Client",details:"Oil Distribution Monitoring - Bangchak",type:"solid",riskIndicator:"Client_Relationship"},
                {source:"n2",target:"n35",rel:"Project_Client",details:"Refinery Monitoring System - PTTGC",type:"solid",riskIndicator:"Client_Relationship"},
                {source:"n2",target:"n36",rel:"Project_Client",details:"Refinery Monitoring System - Star Petroleum",type:"solid",riskIndicator:"Client_Relationship"},
                
                // EDUCATION
                {source:"n32",target:"n41",rel:"Procurement_Winner",details:"STEM Education Materials - Multiple Schools",type:"solid",riskIndicator:"Repeat_Winner"},
                
                // SYSTRONICS-EXPERT PATTERN
                {source:"n12",target:"n23",rel:"Procurement_Pattern",details:"Frequent co-bidders with price clustering",type:"risk",riskIndicator:"High_Risk"},
                
                // NETWORK CONNECTIONS
                {source:"n2",target:"n26",rel:"Procurement_Network",details:"Shared government CCTV/Traffic contracts",type:"hidden",riskIndicator:"Network_Connection"},
                {source:"n12",target:"n27",rel:"Procurement_Network",details:"Coordinated bidding in BKK CCTV projects",type:"hidden",riskIndicator:"Network_Connection"},
                
                // PROEN
                {source:"n42",target:"n37",rel:"Procurement_Bidder",details:"Centralized Log System Project",type:"dashed",riskIndicator:"Contract_Participation"},
                
                // RISK INDICATORS (NEW - from GraphML)
                {source:"n29",target:"n28",rel:"Risk_Indicator",details:"เสนอราคาต่ำกว่าผู้เสนอรายอื่นผิดปกติ - Lost despite lower price",type:"risk",riskIndicator:"Procurement_Anomaly"},
                {source:"n2",target:"n37",rel:"Risk_Indicator",details:"มีผู้เสนอราคาน้อยกว่า 3 ราย - Limited Competition",type:"risk",riskIndicator:"Competition_Risk"},
                {source:"n28",target:"n39",rel:"Risk_Indicator",details:"มูลค่าสัญญาสูงกว่าราคาประมูลชนะ - Contract Inflation",type:"risk",riskIndicator:"Financial_Risk"},
                {source:"n23",target:"n30",rel:"Risk_Indicator",details:"เสนอราคาใกล้ราคากลาง - Suspiciously Close to Reference",type:"risk",riskIndicator:"Information_Leak_Risk"}
            ]
        };

        // PROCUREMENT DATA FROM CSV
        const procurementData = [
            {year:2567,project:"โครงการบริหารจัดการระบบตรวจสอบ ติดตาม ควบคุม",agency:"กรมสรรพสามิต",budget:18000000,winner:"เปรม กรุ๊ป",method:"เฉพาะเจาะจง",risk:["จัดซื้อจัดจ้างแบบเฉพาะเจาะจงท้ายปีงบประมาณ"],status:"won"},
            {year:2567,project:"โครงการซ่อมบำรุงรักษา สอบเทียบ ระบบฉีดสาร Marker",agency:"กรมสรรพสามิต",budget:30386000,winner:"เปรม กรุ๊ป",method:"เฉพาะเจาะจง",risk:["จัดซื้อจัดจ้างแบบเฉพาะเจาะจงท้ายปีงบประมาณ"],status:"won"},
            {year:2567,project:"โครงการซ่อมบำรุงรักษาระบบ Real Time Surveillance",agency:"กรมสรรพสามิต",budget:28370000,winner:"เปรม กรุ๊ป",method:"เฉพาะเจาะจง",risk:["จัดซื้อจัดจ้างแบบเฉพาะเจาะจงท้ายปีงบประมาณ"],status:"won"},
            {year:2567,project:"โครงการจ้างซ่อมบำรุงรักษาระบบควบคุมน้ำมัน",agency:"กรมสรรพสามิต",budget:20810000,winner:"เปรม กรุ๊ป",method:"เฉพาะเจาะจง",risk:["จัดซื้อจัดจ้างแบบเฉพาะเจาะจงท้ายปีงบประมาณ"],status:"won"},
            {year:2565,project:"โครงการปรับปรุงระบบวิทยุสื่อสาร ภาค 4,5,6,10",agency:"กรมสรรพสามิต",budget:87935000,winner:"เปรม กรุ๊ป",method:"e-bidding",risk:["เสนอราคาใกล้ราคากลาง","เสนอราคาเกาะกลุ่ม","มีผู้เสนอราคาน้อยกว่า 3 ราย"],status:"won",bidders:[{name:"เปรม กรุ๊ป",price:87700000},{name:"เค เทคโนโลยี",price:87835000}]},
            {year:2564,project:"โครงการเพิ่มประสิทธิภาพระบบควบคุมน้ำมันดีเซลชาวประมง",agency:"กรมสรรพสามิต",budget:254600000,winner:"เปรม กรุ๊ป",method:"e-bidding",risk:["เสนอราคาใกล้ราคากลาง","เสนอราคาเกาะกลุ่ม","มีผู้เสนอราคาน้อยกว่า 3 ราย"],status:"won",bidders:[{name:"เปรม กรุ๊ป",price:254000000},{name:"ซี อี โอ เทคโนโลยี",price:254300000}]},
            {year:2564,project:"โครงการปรับปรุงระบบวิทยุสื่อสาร ภาค 2,7,8",agency:"กรมสรรพสามิต",budget:73200000,winner:"เปรม กรุ๊ป",method:"e-bidding",risk:["เสนอราคาใกล้ราคากลาง","เสนอราคาเกาะกลุ่ม","มีผู้เสนอราคาน้อยกว่า 3 ราย"],status:"won",bidders:[{name:"ซิสทรอนิกส์",price:73100000},{name:"เปรม กรุ๊ป",price:73000000}]},
            {year:2566,project:"โครงการกำกับและติดตามมาตรฐานสินค้าสุราชุมชน",agency:"กรมสรรพสามิต",budget:67100000,winner:"เปรม กรุ๊ป",method:"e-bidding",risk:["เสนอราคาเกาะกลุ่ม","มีผู้เสนอราคาน้อยกว่า 3 ราย"],status:"won",bidders:[{name:"ซิสทรอนิกส์",price:66900000},{name:"เปรม กรุ๊ป",price:66429000}]},
            {year:2567,project:"โครงการบริหารจัดการสำนวนการตรวจสอบภาษี",agency:"กรมสรรพสามิต",budget:17000000,winner:"ซิสทรอนิกส์",method:"e-bidding",risk:["เสนอราคาเกาะกลุ่ม","มีผู้เสนอราคาน้อยกว่า 3 ราย"],status:"lost",bidders:[{name:"ซิสทรอนิกส์",price:16840000},{name:"เปรม กรุ๊ป",price:16880000}]},
            {year:2567,project:"โครงการบำรุงรักษาระบบ Flow Meter",agency:"กรมสรรพสามิต",budget:19410000,winner:"ซิสทรอนิกส์",method:"คัดเลือก",risk:["เสนอราคาใกล้ราคากลาง","เสนอราคาเกาะกลุ่ม"],status:"lost",bidders:[{name:"เท็คไอที",price:19363000},{name:"ซิสทรอนิกส์",price:19300000},{name:"เปรม กรุ๊ป",price:19355000}]},
            {year:2565,project:"โครงการพัฒนาระบบค้นหาและติดตามการขนส่งน้ำมัน",agency:"กรมสรรพสามิต",budget:47700000,winner:"ซิสทรอนิกส์",method:"คัดเลือก",risk:["เสนอราคาใกล้ราคากลาง","เสนอราคาเกาะกลุ่ม"],status:"lost",bidders:[{name:"บีทามส์",price:47594300},{name:"ซิสทรอนิกส์",price:47575000},{name:"เปรม กรุ๊ป",price:47610000}]}
        ];

        // CLUSTER DATA
        const clusterData = {
            central: {
                title: 'Central Hub',
                risk: 'Critical',
                entities: ['n1', 'n2', 'n3', 'n4'],
                description: 'Patikorn controls 97.8% of Pram Group with family member Thanathep holding 2.1%. CEO Peerapol (0.1%) creates corporate governance facade while power remains concentrated.',
                descriptionTh: 'ปฏิกรถือหุ้น 97.8% ในเปรม กรุ๊ป โดยสมาชิกในครอบครัว ธนเทพ ถือ 2.1% CEO พีรพล (0.1%) สร้างภาพธรรมาภิบาลในขณะที่อำนาจยังรวมศูนย์',
                keyFindings: ['97.8% single-person ownership concentration', 'Family member cross-shareholding pattern', 'CEO holds minimal stake (0.1%)'],
                keyFindingsTh: ['ความเข้มข้นการถือหุ้น 97.8% โดยคนเดียว', 'รูปแบบการถือหุ้นไขว้ของสมาชิกในครอบครัว', 'CEO ถือหุ้นน้อยมาก (0.1%)']
            },
            phoenix: {
                title: 'Phoenix-Prem Chain',
                risk: 'High',
                entities: ['n5', 'n6', 'n7', 'n8', 'n9'],
                description: 'Dissolved "Prem Engineering" partnership links Suwanee (98% Phoenix) to Jeerapong (K Technology). K Tech shows 100% loss rate (0/9 wins) against Pram - classic support bidder pattern.',
                descriptionTh: 'ห้างหุ้นส่วน "เปรม เอ็นจิเนียริ่ง" ที่เลิกกิจการเชื่อม สุวรรณี (98% ฟีนิกซ์) กับ จีรพงษ์ (K Technology) K Tech แพ้ 100% (0/9 ครั้ง) กับ Pram - รูปแบบผู้สนับสนุนการประมูล',
                keyFindings: ['Phonetic similarity: "Pram" vs "Prem"', '100% loss rate (0/9) against Pram', 'Hidden ownership chain via dissolved entity'],
                keyFindingsTh: ['เสียงคล้าย: "เปรม กรุ๊ป" vs "เปรม เอ็นจิเนียริ่ง"', 'อัตราแพ้ 100% (0/9) กับ Pram', 'ห่วงโซ่การถือหุ้นซ่อนผ่านบริษัทที่เลิก']
            },
            systronics: {
                title: 'Systronics Bridge',
                risk: 'Critical',
                entities: ['n10', 'n11', 'n12', 'n13', 'n14'],
                description: 'Kriangsak Imsri bridges Pram (via Krungthep Brew House) to Systronics (50% ownership). Combined 28+ projects with price clustering. Total contract value exceeds 2.4B THB.',
                descriptionTh: 'เกรียงศักดิ์ อิ่มศรี เชื่อม Pram (ผ่านกรุงเทพ บริว เฮาส์) กับ Systronics (ถือ 50%) รวม 28+ โครงการที่มีราคาเกาะกลุ่ม มูลค่าสัญญารวมเกิน 2.4 พันล้านบาท',
                keyFindings: ['28+ projects with alternating wins', 'Bridge director connects both entities', 'Price clustering in government contracts'],
                keyFindingsTh: ['28+ โครงการที่ชนะสลับกัน', 'กรรมการเชื่อมทั้งสองบริษัท', 'ราคาเกาะกลุ่มในสัญญาภาครัฐ']
            },
            cctv: {
                title: 'CCTV Ring',
                risk: 'High',
                entities: ['n12', 'n26', 'n27', 'n38'],
                description: 'Bangkok CCTV maintenance project: Genius (88.6M), Vision Security (88.87M), Systronics (88.86M). Price difference <0.3% among competitors - statistically improbable without coordination.',
                descriptionTh: 'โครงการบำรุงรักษา CCTV กทม.: Genius (88.6M), Vision (88.87M), Systronics (88.86M) ราคาต่างกัน <0.3% - ไม่น่าจะเป็นไปได้ทางสถิติหากไม่ประสานงาน',
                keyFindings: ['Three-way price clustering (<0.3% variance)', 'Winner by 0.26M margin', 'Statistical impossibility of coincidence'],
                keyFindingsTh: ['ราคาเกาะกลุ่ม 3 ทาง (<0.3% ความแปรปรวน)', 'ชนะด้วยส่วนต่าง 0.26M', 'ไม่น่าจะเป็นความบังเอิญทางสถิติ']
            },
            support: {
                title: 'Support Bidders',
                risk: 'High',
                entities: ['n9', 'n23', 'n24', 'n25'],
                description: 'K Technology (0/9 wins) and Expert Engineering (0/6 wins) show 100% loss rates against Pram. I-3 Creation and TA Systems act as validators to legitimize bidding process.',
                descriptionTh: 'K Technology (0/9 ครั้ง) และ Expert Engineering (0/6 ครั้ง) แพ้ 100% กับ Pram I-3 Creation และ TA Systems ทำหน้าที่ผู้ตรวจสอบเพื่อให้กระบวนการประมูลดูถูกต้อง',
                keyFindings: ['100% loss rate against Pram', 'Validators legitimize bid process', 'Consistent pattern across multiple tenders'],
                keyFindingsTh: ['อัตราแพ้ 100% กับ Pram', 'ผู้ตรวจสอบทำให้การประมูลดูถูกต้อง', 'รูปแบบสม่ำเสมอในหลายการประมูล']
            }
        };

        // CHART MANAGER
        const ChartManager = {
            instances: {},
            render: (id, type, data, opts) => {
                const ctx = document.getElementById(id);
                if(!ctx) return;
                if(ChartManager.instances[id]) ChartManager.instances[id].destroy();
                ChartManager.instances[id] = new Chart(ctx, { type, data, options: opts });
            }
        };

        // NETWORK GLOBALS
        let networkSvg, networkZoom, showLabels = true;

        // D3 NETWORK INITIALIZATION
        function initNetwork() {
            const container = document.getElementById('network-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            d3.select('#network-svg').selectAll('*').remove();
            
            const svg = d3.select('#network-svg')
                .attr('width', width)
                .attr('height', height);
            
            networkSvg = svg;
            
            // Arrow markers
            const defs = svg.append('defs');
            ['solid', 'dashed', 'risk', 'hidden'].forEach(type => {
                const color = type === 'risk' ? '#ef4444' : type === 'hidden' ? '#8b5cf6' : type === 'dashed' ? '#a78bfa' : '#3b82f6';
                defs.append('marker')
                    .attr('id', `arrow-${type}`)
                    .attr('viewBox', '0 -5 10 10')
                    .attr('refX', 20)
                    .attr('refY', 0)
                    .attr('markerWidth', 4)
                    .attr('markerHeight', 4)
                    .attr('orient', 'auto')
                    .append('path')
                    .attr('fill', color)
                    .attr('d', 'M0,-5L10,0L0,5');
            });
            
            const g = svg.append('g');
            
            // Zoom
            const zoom = d3.zoom()
                .scaleExtent([0.2, 4])
                .on('zoom', (event) => g.attr('transform', event.transform));
            svg.call(zoom);
            networkZoom = zoom;
            
            // Simulation
            const simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(40));
            
            // Links
            const link = g.append('g')
                .selectAll('line')
                .data(graphData.links)
                .join('line')
                .attr('class', 'link')
                .attr('stroke', d => d.type === 'risk' ? '#ef4444' : d.type === 'hidden' ? '#8b5cf6' : d.type === 'dashed' ? '#a78bfa' : '#3b82f6')
                .attr('stroke-opacity', d => d.type === 'hidden' ? 0.3 : 0.5)
                .attr('stroke-width', d => d.type === 'risk' ? 2 : 1.5)
                .attr('stroke-dasharray', d => d.type === 'dashed' || d.type === 'hidden' ? '4,4' : 'none')
                .attr('marker-end', d => `url(#arrow-${d.type || 'solid'})`);
            
            // Nodes
            const node = g.append('g')
                .selectAll('.node')
                .data(graphData.nodes)
                .join('g')
                .attr('class', 'node')
                .style('cursor', 'pointer')
                .call(d3.drag()
                    .on('start', (event, d) => { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
                    .on('drag', (event, d) => { d.fx = event.x; d.fy = event.y; })
                    .on('end', (event, d) => { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; })
                )
                .on('click', (event, d) => APP.showEntityDetails(d));
            
            // Node shapes
            node.each(function(d) {
                const el = d3.select(this);
                const size = d.risk === 'Critical' ? 14 : d.risk === 'High' ? 11 : 9;
                const fill = d.type === 'Person' ? '#3b82f6' : d.type === 'Government' ? '#10b981' : '#8b5cf6';
                
                if(d.type === 'Person') {
                    el.append('circle').attr('r', size).attr('fill', fill).attr('stroke', d.risk === 'Critical' ? '#ef4444' : '#fff').attr('stroke-width', d.risk === 'Critical' ? 3 : 1.5);
                } else if(d.type === 'Government') {
                    el.append('polygon').attr('points', `-${size},-${size*0.6} ${size},-${size*0.6} ${size*1.3},0 ${size},${size*0.6} -${size},${size*0.6} -${size*1.3},0`)
                      .attr('fill', fill).attr('stroke', '#fff').attr('stroke-width', 1.5);
                } else {
                    el.append('rect').attr('x', -size).attr('y', -size * 0.7).attr('width', size * 2).attr('height', size * 1.4).attr('rx', 3)
                      .attr('fill', fill).attr('stroke', d.risk === 'Critical' ? '#ef4444' : d.category === 'Key_Connector' ? '#f59e0b' : '#fff').attr('stroke-width', d.risk === 'Critical' || d.category === 'Key_Connector' ? 2.5 : 1.5);
                }
                
                if(d.risk === 'Critical') {
                    el.append('circle').attr('r', size + 6).attr('fill', 'none').attr('stroke', '#ef4444').attr('stroke-width', 1).attr('stroke-dasharray', '2,2').attr('opacity', 0.5);
                }
            });
            
            // Labels
            node.append('text')
                .attr('class', 'node-label')
                .attr('dy', d => (d.risk === 'Critical' ? 14 : d.risk === 'High' ? 11 : 9) + 14)
                .attr('text-anchor', 'middle')
                .attr('fill', '#a1a1a6')
                .attr('font-size', '8px')
                .attr('font-family', 'Inter, sans-serif')
                .text(d => d.label.length > 20 ? d.label.substring(0, 20) + '...' : d.label);
            
            simulation.on('tick', () => {
                link.attr('x1', d => d.source.x).attr('y1', d => d.source.y).attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }

        // HYBRID ATMOSPHERE ENGINE (Three.js + Canvas Fallback)
        class AntigravityEngine {
            constructor() {
                this.canvas = document.getElementById('antigravity-canvas');
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                if(typeof THREE !== 'undefined') {
                    try {
                        this.initThreeJS();
                        console.log('[Physics] WebGL Engine Active');
                        return;
                    } catch(e) {
                        console.warn('[Physics] WebGL failed, using Canvas fallback');
                    }
                }
                this.initCanvasFallback();
            }
            
            initThreeJS() {
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ canvas: this.canvas, alpha: true, antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                
                // Particles
                const particleGeometry = new THREE.BufferGeometry();
                const count = 400;
                const positions = new Float32Array(count * 3);
                for(let i = 0; i < count * 3; i += 3) {
                    positions[i] = (Math.random() - 0.5) * 80;
                    positions[i + 1] = (Math.random() - 0.5) * 80;
                    positions[i + 2] = (Math.random() - 0.5) * 80;
                }
                particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                const particleMaterial = new THREE.PointsMaterial({ color: 0x3b82f6, size: 0.08, transparent: true, opacity: 0.6 });
                const particles = new THREE.Points(particleGeometry, particleMaterial);
                scene.add(particles);
                
                // Torus ring
                const torusGeometry = new THREE.TorusGeometry(15, 0.1, 16, 100);
                const torusMaterial = new THREE.PointsMaterial({ color: 0x8b5cf6, size: 0.05, transparent: true, opacity: 0.4 });
                const torus = new THREE.Points(torusGeometry, torusMaterial);
                scene.add(torus);
                
                camera.position.z = 35;
                
                const animate = () => {
                    requestAnimationFrame(animate);
                    particles.rotation.y += 0.0003;
                    particles.rotation.x += 0.0001;
                    torus.rotation.x += 0.001;
                    torus.rotation.y += 0.002;
                    renderer.render(scene, camera);
                };
                animate();
                
                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }
            
            initCanvasFallback() {
                console.log('[Physics] Canvas 2D Fallback Active');
                const ctx = this.canvas.getContext('2d');
                let w = this.canvas.width;
                let h = this.canvas.height;
                const particles = [];
                const count = Math.min(80, Math.floor((w * h) / 20000));
                
                for(let i = 0; i < count; i++) {
                    particles.push({
                        x: Math.random() * w,
                        y: Math.random() * h,
                        vx: (Math.random() - 0.5) * 0.5,
                        vy: (Math.random() - 0.5) * 0.5,
                        r: Math.random() * 2 + 1,
                        alpha: Math.random() * 0.5 + 0.2
                    });
                }
                
                const draw = () => {
                    ctx.clearRect(0, 0, w, h);
                    
                    // Draw connections
                    ctx.strokeStyle = 'rgba(59, 130, 246, 0.1)';
                    ctx.lineWidth = 0.5;
                    for(let i = 0; i < particles.length; i++) {
                        for(let j = i + 1; j < particles.length; j++) {
                            const dx = particles[i].x - particles[j].x;
                            const dy = particles[i].y - particles[j].y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            if(dist < 120) {
                                ctx.beginPath();
                                ctx.moveTo(particles[i].x, particles[i].y);
                                ctx.lineTo(particles[j].x, particles[j].y);
                                ctx.stroke();
                            }
                        }
                    }
                    
                    // Draw particles
                    particles.forEach(p => {
                        p.x += p.vx;
                        p.y += p.vy;
                        if(p.x < 0 || p.x > w) p.vx *= -1;
                        if(p.y < 0 || p.y > h) p.vy *= -1;
                        
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(59, 130, 246, ${p.alpha})`;
                        ctx.fill();
                    });
                    
                    requestAnimationFrame(draw);
                };
                draw();
                
                window.addEventListener('resize', () => {
                    w = this.canvas.width = window.innerWidth;
                    h = this.canvas.height = window.innerHeight;
                });
            }
        }

        // APP CORE
        const APP = {
            lang: 'en',
            currentCluster: 'central',
            
            init: () => {
                document.getElementById('loading-overlay').classList.add('opacity-0', 'pointer-events-none');
                
                // Inject icons
                document.getElementById('logo-slot').innerHTML = ICONS.logo;
                document.getElementById('icon-globe').innerHTML = ICONS.globe;
                document.getElementById('icon-help').innerHTML = ICONS.help;
                document.getElementById('icon-reset').innerHTML = ICONS.reset;
                document.getElementById('icon-alert').innerHTML = ICONS.alert;
                document.getElementById('icon-bridge').innerHTML = ICONS.bridge;
                document.getElementById('icon-search').innerHTML = ICONS.search;
                document.getElementById('icon-close').innerHTML = ICONS.close;
                document.getElementById('icon-zoom-in').innerHTML = ICONS.zoomIn;
                document.getElementById('icon-zoom-out').innerHTML = ICONS.zoomOut;
                document.getElementById('icon-center').innerHTML = ICONS.center;
                
                APP.initObservers();
                APP.renderCharts();
                APP.renderEntityTable();
                APP.renderProcurementTimeline();
                APP.showCluster('central');
                initNetwork();
                new AntigravityEngine();
            },
            
            toggleLang: () => {
                APP.lang = APP.lang === 'en' ? 'th' : 'en';
                document.body.dataset.lang = APP.lang;
                APP.showCluster(APP.currentCluster);
            },
            
            renderCharts: () => {
                ChartManager.render('radarChart', 'radar', {
                    labels: ['Ownership', 'Gov Exposure', 'Cross-Share', 'Bridge Risk', 'Collusion', 'Support Bid'],
                    datasets: [{ label: 'Risk', data: [98, 92, 78, 85, 95, 88], backgroundColor: 'rgba(239, 68, 68, 0.2)', borderColor: '#ef4444', borderWidth: 2 }]
                }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { r: { min: 0, max: 100, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.08)' }, pointLabels: { color: '#86868b', font: { size: 8 } } } } });
                
                ChartManager.render('doughnutChart', 'doughnut', {
                    labels: ['Person', 'Company', 'Government'],
                    datasets: [{ data: [14, 23, 5], backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981'], borderColor: '#0a0a0f', borderWidth: 2 }]
                }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#86868b', font: { size: 9 }, padding: 10 } } } });
                
                ChartManager.render('barChart', 'bar', {
                    labels: ['Critical', 'High', 'Medium', 'Low'],
                    datasets: [{ data: [4, 12, 18, 8], backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e'], borderRadius: 4 }]
                }, { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#86868b' } }, y: { grid: { display: false }, ticks: { color: '#86868b', font: { size: 9 } } } } });
            },
            
            renderEntityTable: (filter = '') => {
                const tbody = document.getElementById('entity-table-body');
                let nodes = graphData.nodes;
                if(filter) {
                    const f = filter.toLowerCase();
                    nodes = nodes.filter(n => n.label.toLowerCase().includes(f) || n.type.toLowerCase().includes(f) || n.category.toLowerCase().includes(f));
                }
                
                tbody.innerHTML = nodes.map(n => {
                    const typeBadge = n.type === 'Person' ? 'badge-person' : (n.type === 'Government' ? 'badge-government' : 'badge-company');
                    return `<tr onclick="APP.showEntityDetails(graphData.nodes.find(x => x.id === '${n.id}'))">
                        <td class="truncate" style="max-width:200px;">${n.label}</td>
                        <td><span class="badge ${typeBadge}">${n.type}</span></td>
                        <td><span class="badge badge-${n.risk.toLowerCase()}">${n.risk}</span></td>
                        <td class="text-xs text-muted">${n.category.replace(/_/g, ' ')}</td>
                    </tr>`;
                }).join('');
            },
            
            renderProcurementTimeline: () => {
                // Pram Group major contracts
                const pramContracts = procurementData.filter(p => p.winner === 'เปรม กรุ๊ป').slice(0, 8);
                document.getElementById('procurement-pram').innerHTML = pramContracts.map(p => {
                    const riskClass = p.risk && p.risk.length > 0 ? 'risk' : 'won';
                    return `<div class="procurement-card ${riskClass}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xs font-mono text-muted">${p.year}</span>
                            <span class="text-xs font-mono text-emerald">${(p.budget/1000000).toFixed(1)}M</span>
                        </div>
                        <div class="text-sm text-silver truncate mb-1">${p.project.substring(0, 50)}...</div>
                        <div class="text-xs text-muted">${p.agency} • ${p.method}</div>
                        ${p.risk && p.risk.length > 0 ? `<div class="mt-1 flex flex-wrap gap-1">${p.risk.map(r => `<span class="badge badge-high" style="font-size:0.5rem;">${r.substring(0,15)}...</span>`).join('')}</div>` : ''}
                    </div>`;
                }).join('');
                
                // Co-bidding patterns
                const cobidContracts = procurementData.filter(p => p.bidders && p.bidders.length > 1).slice(0, 6);
                document.getElementById('procurement-cobid').innerHTML = cobidContracts.map(p => {
                    return `<div class="procurement-card ${p.status === 'won' ? 'won' : 'lost'}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xs font-mono text-muted">${p.year}</span>
                            <span class="badge ${p.status === 'won' ? 'badge-low' : 'badge-high'}">${p.status}</span>
                        </div>
                        <div class="text-sm text-silver truncate mb-2">${p.project.substring(0, 45)}...</div>
                        <div class="text-xs text-muted mb-1">Bidders:</div>
                        ${p.bidders.map(b => `<div class="text-xs flex justify-between ${b.name.includes('เปรม') ? 'text-neon' : 'text-muted'}"><span>${b.name}</span><span class="font-mono">${(b.price/1000000).toFixed(2)}M</span></div>`).join('')}
                    </div>`;
                }).join('');
            },
            
            searchEntities: (q) => APP.renderEntityTable(q),
            
            showCluster: (id) => {
                APP.currentCluster = id;
                const c = clusterData[id];
                const lang = APP.lang;
                document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === id));
                
                document.getElementById('cluster-content').innerHTML = `
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <div class="flex gap-2 mb-3"><span class="badge badge-${c.risk.toLowerCase()}">${c.risk}</span><span class="text-xs text-muted">${c.entities.length} entities</span></div>
                            <p class="text-sm text-silver mb-4">${lang === 'th' ? c.descriptionTh : c.description}</p>
                            <div class="text-xs text-muted uppercase tracking-wider font-display mb-2">${lang === 'th' ? 'ข้อค้นพบ' : 'Key Findings'}</div>
                            <ul class="space-y-1">${(lang === 'th' ? c.keyFindingsTh : c.keyFindings).map(f => `<li class="text-sm text-silver flex gap-2"><span class="text-neon">→</span>${f}</li>`).join('')}</ul>
                        </div>
                        <div>
                            <div class="text-xs text-muted uppercase tracking-wider font-display mb-2">${lang === 'th' ? 'หน่วยงาน' : 'Entities'}</div>
                            <div class="space-y-1">${c.entities.map(eid => {
                                const e = graphData.nodes.find(n => n.id === eid);
                                return e ? `<div class="text-xs p-2 rounded bg-white/5 flex justify-between cursor-pointer hover:bg-white/10" onclick="APP.focusNode('${eid}')"><span class="truncate">${e.label}</span><span class="badge badge-${e.risk.toLowerCase()}">${e.risk}</span></div>` : '';
                            }).join('')}</div>
                        </div>
                    </div>`;
            },
            
            showEntityDetails: (e) => {
                const panel = document.getElementById('slide-panel');
                const backdrop = document.getElementById('panel-backdrop');
                document.getElementById('panel-title').textContent = e.label;
                
                const conns = graphData.links.filter(l => (l.source.id || l.source) === e.id || (l.target.id || l.target) === e.id);
                const typeBadge = e.type === 'Person' ? 'badge-person' : (e.type === 'Government' ? 'badge-government' : 'badge-company');
                
                // Find related procurement records
                const relatedProcurements = procurementData.filter(p => 
                    p.winner && p.winner.includes(e.label.substring(0, 10)) ||
                    (p.bidders && p.bidders.some(b => b.name.includes(e.label.substring(0, 10))))
                ).slice(0, 5);
                
                document.getElementById('panel-content').innerHTML = `
                    <div class="flex gap-2 mb-4 flex-wrap"><span class="badge ${typeBadge}">${e.type}</span><span class="badge badge-${e.risk.toLowerCase()}">${e.risk}</span></div>
                    <div class="text-xs text-muted mb-1">Category: <span class="text-silver">${e.category.replace(/_/g, ' ')}</span></div>
                    <div class="text-xs text-muted mb-4">Connections: <span class="text-neon font-bold">${conns.length}</span></div>
                    <div class="border-t border-glass pt-4 mb-4">
                        <div class="text-xs text-muted uppercase tracking-wider font-display mb-3">Connection Details</div>
                        <div class="space-y-2" style="max-height:200px;overflow-y:auto;">
                            ${conns.map(c => {
                                const isSource = (c.source.id || c.source) === e.id;
                                const otherId = isSource ? (c.target.id || c.target) : (c.source.id || c.source);
                                const other = graphData.nodes.find(n => n.id === otherId);
                                if(!other) return '';
                                const riskClass = c.type === 'risk' ? 'text-danger' : '';
                                return `<div class="p-2 rounded bg-white/5 text-xs"><div class="text-silver mb-1 ${riskClass}">${other.label}</div><div class="text-muted">${isSource ? '→' : '←'} ${c.rel} • ${c.details}</div>${c.riskIndicator ? `<div class="text-xs text-warning mt-1">⚠ ${c.riskIndicator.replace(/_/g, ' ')}</div>` : ''}</div>`;
                            }).join('')}
                        </div>
                    </div>
                    ${relatedProcurements.length > 0 ? `
                    <div class="border-t border-glass pt-4">
                        <div class="text-xs text-muted uppercase tracking-wider font-display mb-3">Related Procurements</div>
                        <div class="space-y-2">
                            ${relatedProcurements.map(p => `<div class="p-2 rounded bg-white/5 text-xs">
                                <div class="flex justify-between"><span class="text-muted">${p.year}</span><span class="text-emerald font-mono">${(p.budget/1000000).toFixed(1)}M</span></div>
                                <div class="text-silver truncate">${p.project.substring(0, 40)}...</div>
                            </div>`).join('')}
                        </div>
                    </div>` : ''}`;
                
                panel.classList.add('open');
                backdrop.classList.add('open');
            },
            
            closePanel: () => {
                document.getElementById('slide-panel').classList.remove('open');
                document.getElementById('panel-backdrop').classList.remove('open');
            },
            
            focusNode: (id) => {
                const n = graphData.nodes.find(x => x.id === id);
                if(n && n.x && networkSvg && networkZoom) {
                    const container = document.getElementById('network-container');
                    networkSvg.transition().duration(750).call(networkZoom.transform, d3.zoomIdentity.translate(container.clientWidth/2 - n.x*2, container.clientHeight/2 - n.y*2).scale(2));
                }
            },
            
            filterNetwork: (f) => {
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.toggle('active', c.dataset.filter === f));
                d3.selectAll('.node').style('opacity', d => {
                    if(f === 'all') return 1;
                    if(f === 'person' && d.type === 'Person') return 1;
                    if(f === 'company' && d.type === 'Company') return 1;
                    if(f === 'government' && d.type === 'Government') return 1;
                    if(f === 'critical' && d.risk === 'Critical') return 1;
                    return 0.1;
                });
            },
            
            showProcurementTab: (tab) => {
                // Could expand to filter procurement display
                APP.renderProcurementTimeline();
            },
            
            resetNetwork: () => { if(networkSvg && networkZoom) networkSvg.transition().duration(750).call(networkZoom.transform, d3.zoomIdentity); APP.filterNetwork('all'); },
            highlightBridges: () => { d3.selectAll('.node').style('opacity', d => ['Key_Connector','Central_Figure','Central_Hub'].includes(d.category) ? 1 : 0.15); },
            highlightCollusion: () => { const s = new Set(); graphData.links.filter(l => l.type === 'risk').forEach(l => { s.add(l.source.id || l.source); s.add(l.target.id || l.target); }); d3.selectAll('.node').style('opacity', d => s.has(d.id) ? 1 : 0.12); },
            zoomIn: () => { if(networkSvg && networkZoom) networkSvg.transition().duration(300).call(networkZoom.scaleBy, 1.4); },
            zoomOut: () => { if(networkSvg && networkZoom) networkSvg.transition().duration(300).call(networkZoom.scaleBy, 0.7); },
            centerNetwork: () => APP.resetNetwork(),
            initObservers: () => { const o = new IntersectionObserver(e => e.forEach(x => x.target.classList.toggle('active', x.isIntersecting)), { threshold: 0.1 }); document.querySelectorAll('.reveal').forEach(el => o.observe(el)); },
            toggleHelp: () => alert(APP.lang === 'th' ? 'คู่มือ NEXUS:\n• คลิกโหนดดูรายละเอียด\n• ลากโหนดจัดตำแหน่ง\n• เลื่อนเมาส์ซูม\n• ใช้ตัวกรองเน้นหน่วยงาน' : 'NEXUS Guide:\n• Click nodes for details\n• Drag to reposition\n• Scroll to zoom\n• Use filters to highlight')
        };

        // RESILIENT LOADER
        function waitForLibs(r = 0) {
            if(typeof d3 !== 'undefined' && typeof Chart !== 'undefined') { console.log(`[Nexus] Loaded (${r*100}ms)`); APP.init(); }
            else if(r < 50) setTimeout(() => waitForLibs(r + 1), 100);
            else document.getElementById('loading-overlay').innerHTML = '<div class="text-danger p-8">Failed to load. Please refresh.</div>';
        }
        document.addEventListener('DOMContentLoaded', () => waitForLibs());
    </script>
</body>
</html>
