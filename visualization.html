<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Analysis - Adaptive Visualization v4.0</title>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --classic-blue: #0F4C81;
            --ultimate-gray: #939597;
            --illuminating: #F5DF4D;
            --very-peri: #6667AB;
            --viva-magenta: #BB2649;
            --peach-fuzz: #FFBE98;
            --mocha-mousse: #A47764;
            
            --bg-primary: #0a0e27;
            --bg-secondary: #151932;
            --text-primary: #ffffff;
            --text-secondary: #a0a9c9;
            --border-color: #2a3456;
            
            --gradient-primary: linear-gradient(135deg, var(--very-peri) 0%, var(--viva-magenta) 100%);
            --gradient-secondary: linear-gradient(135deg, var(--peach-fuzz) 0%, var(--mocha-mousse) 100%);
            --gradient-dark: linear-gradient(180deg, #0a0e27 0%, #151932 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            opacity: 0.03;
            background-image: 
                radial-gradient(circle at 20% 50%, var(--very-peri) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, var(--viva-magenta) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, var(--peach-fuzz) 0%, transparent 50%);
            animation: bgMove 20s ease-in-out infinite;
        }
        
        @keyframes bgMove {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(-20px, -20px) scale(1.1); }
            66% { transform: translate(20px, -10px) scale(0.9); }
        }
        
        .header {
            padding: 2rem 0;
            text-align: center;
            background: rgba(21, 25, 50, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { filter: drop-shadow(0 0 20px rgba(102, 103, 171, 0.5)); }
            to { filter: drop-shadow(0 0 30px rgba(187, 38, 73, 0.8)); }
        }
        
        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        .header .subtitle {
            font-size: 0.85rem;
            margin-top: 0.5rem;
            color: var(--illuminating);
        }
        
        .controls {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-group {
            background: rgba(42, 52, 86, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        .control-group:hover {
            background: rgba(42, 52, 86, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 103, 171, 0.2);
        }
        
        .control-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .control-group select,
        .control-group input {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.95rem;
            min-width: 150px;
            transition: all 0.3s ease;
        }
        
        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: var(--very-peri);
            box-shadow: 0 0 0 3px rgba(102, 103, 171, 0.1);
        }
        
        .btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(187, 38, 73, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .stats-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .stat-card {
            background: rgba(42, 52, 86, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 103, 171, 0.2);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-secondary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .matrix-container {
            max-width: 1400px;
            margin: 3rem auto;
            padding: 0 2rem;
            background: rgba(21, 25, 50, 0.5);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        
        .matrix-header {
            padding: 2rem;
            background: rgba(42, 52, 86, 0.2);
            border-bottom: 1px solid var(--border-color);
        }
        
        .matrix-header h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            background: var(--gradient-secondary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .matrix-viz {
            padding: 2rem;
            min-height: 600px;
            position: relative;
            overflow-x: auto;
        }
        
        .cell {
            stroke: var(--border-color);
            stroke-width: 1;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .cell:hover {
            stroke: var(--illuminating);
            stroke-width: 2;
            filter: brightness(1.2);
        }
        
        .axis-label {
            font-size: 12px;
            fill: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .axis-label:hover {
            fill: var(--illuminating);
        }
        
        .total-label {
            font-size: 13px;
            fill: var(--illuminating);
            font-weight: 700;
        }
        
        .tooltip {
            position: absolute;
            padding: 1rem;
            background: rgba(10, 14, 39, 0.95);
            border: 1px solid var(--very-peri);
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            max-width: 400px;
        }
        
        .tooltip.show {
            opacity: 1;
        }
        
        .tooltip h3 {
            color: var(--illuminating);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .tooltip p {
            color: var(--text-primary);
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }
        
        .tooltip .count {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--peach-fuzz);
        }
        
        .legend {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: rgba(42, 52, 86, 0.2);
            border-top: 1px solid var(--border-color);
        }
        
        .legend-gradient {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 30px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .legend-labels {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 600px;
            margin-top: 0.5rem;
        }
        
        .legend-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .legend-title {
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--very-peri);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .label-tooltip {
            position: absolute;
            padding: 0.5rem 1rem;
            background: rgba(10, 14, 39, 0.95);
            border: 1px solid var(--very-peri);
            border-radius: 6px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 2000;
            font-size: 0.9rem;
            color: var(--text-primary);
            white-space: nowrap;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .label-tooltip.show {
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .matrix-viz {
                padding: 1rem;
            }
        }
        
        .tab-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .tab {
            background: rgba(42, 52, 86, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 12px 12px 0 0;
            padding: 1rem 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .tab:hover {
            background: rgba(42, 52, 86, 0.5);
            color: var(--text-primary);
        }
        
        .tab.active {
            background: var(--gradient-primary);
            color: white;
            border-bottom-color: transparent;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .scale-info {
            font-size: 0.85rem;
            color: var(--illuminating);
            margin-top: 0.5rem;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <header class="header">
        <h1>Account Analysis - Adaptive Visualization v4.0</h1>
        <p>Interactive Matrix Visualization with Dynamic Scaling & LOT Consolidation</p>
        <p class="subtitle">
            Mode: CONSTRAINED | Generated: 2025-10-12 20:21:42
        </p>
    </header>
    
    <div class="controls">
        <div class="control-group">
            <label for="colorScheme">Color Scheme</label>
            <select id="colorScheme">
                <option value="pantone">Pantone Colors</option>
                <option value="viridis">Viridis</option>
                <option value="plasma">Plasma</option>
                <option value="inferno">Inferno</option>
                <option value="turbo">Turbo</option>
                <option value="cool">Cool Tones</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="scaleType">Scale Type</label>
            <select id="scaleType">
                <option value="log">Logarithmic (Recommended)</option>
                <option value="linear">Linear</option>
                <option value="quantile">Quantile-based</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="cellSize">Cell Size</label>
            <input type="range" id="cellSize" min="30" max="80" value="50">
        </div>
        
        <div class="control-group">
            <button class="btn" onclick="resetView()">Reset View</button>
        </div>
        
        <div class="control-group">
            <button class="btn" onclick="exportData()">Export CSV</button>
        </div>
    </div>
    
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-value" id="totalAccounts">0</div>
            <div class="stat-label">Total Accounts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalGroups">0</div>
            <div class="stat-label">Groups</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalLots">0</div>
            <div class="stat-label">Lots</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalFlags">0</div>
            <div class="stat-label">Group Flags</div>
        </div>
    </div>
    
    <div class="tab-container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab(event, 'group-lot')">GROUP × LOT Matrix</div>
            <div class="tab" onclick="switchTab(event, 'lot-flag')">LOT × GROUP_FLAG Matrix</div>
        </div>
    </div>
    
    <div id="group-lot-content" class="tab-content active">
        <div class="matrix-container">
            <div class="matrix-header">
                <h2>GROUP × LOT Matrix</h2>
                <p>Click cells for details • Hover for stats • Dynamic logarithmic scaling</p>
                <p id="group-lot-verification" style="margin-top: 0.5rem; color: var(--illuminating); font-size: 0.9rem;"></p>
                <p id="group-lot-scale-info" class="scale-info"></p>
            </div>
            
            <div id="matrix-viz-1" class="matrix-viz">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
            
            <div class="legend">
                <div class="legend-title">Account Count Distribution</div>
                <svg id="legend-gradient-1" class="legend-gradient"></svg>
                <div id="legend-labels-1" class="legend-labels"></div>
            </div>
        </div>
    </div>
    
    <div id="lot-flag-content" class="tab-content">
        <div class="matrix-container">
            <div class="matrix-header">
                <h2>LOT × GROUP_FLAG Matrix</h2>
                <p>Click cells for details • Hover for stats • Dynamic logarithmic scaling</p>
                <p id="lot-flag-verification" style="margin-top: 0.5rem; color: var(--illuminating); font-size: 0.9rem;"></p>
                <p id="lot-flag-scale-info" class="scale-info"></p>
            </div>
            
            <div id="matrix-viz-2" class="matrix-viz">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
            
            <div class="legend">
                <div class="legend-title">Account Count Distribution</div>
                <svg id="legend-gradient-2" class="legend-gradient"></svg>
                <div id="legend-labels-2" class="legend-labels"></div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    <div class="label-tooltip" id="labelTooltip"></div>
    
    <script>
        const VISUALIZATION_DATA = {
  "group_lot_matrix": {
    "groups": [
      "GF1",
      "GF2",
      "GF3",
      "GF4"
    ],
    "lots": [
      "1",
      "2",
      "3",
      "4",
      "5",
      "6"
    ],
    "matrix": [
      {
        "group": "GF1",
        "lot": "1",
        "count": 519938
      },
      {
        "group": "GF1",
        "lot": "2",
        "count": 424963
      },
      {
        "group": "GF1",
        "lot": "3",
        "count": 572364
      },
      {
        "group": "GF1",
        "lot": "4",
        "count": 681485
      },
      {
        "group": "GF1",
        "lot": "5",
        "count": 389451
      },
      {
        "group": "GF1",
        "lot": "6",
        "count": 456023
      },
      {
        "group": "GF2",
        "lot": "1",
        "count": 0
      },
      {
        "group": "GF2",
        "lot": "2",
        "count": 1
      },
      {
        "group": "GF2",
        "lot": "3",
        "count": 0
      },
      {
        "group": "GF2",
        "lot": "4",
        "count": 913
      },
      {
        "group": "GF2",
        "lot": "5",
        "count": 116
      },
      {
        "group": "GF2",
        "lot": "6",
        "count": 564
      },
      {
        "group": "GF3",
        "lot": "1",
        "count": 0
      },
      {
        "group": "GF3",
        "lot": "2",
        "count": 3695
      },
      {
        "group": "GF3",
        "lot": "3",
        "count": 42
      },
      {
        "group": "GF3",
        "lot": "4",
        "count": 196935
      },
      {
        "group": "GF3",
        "lot": "5",
        "count": 193017
      },
      {
        "group": "GF3",
        "lot": "6",
        "count": 147517
      },
      {
        "group": "GF4",
        "lot": "1",
        "count": 0
      },
      {
        "group": "GF4",
        "lot": "2",
        "count": 4
      },
      {
        "group": "GF4",
        "lot": "3",
        "count": 202061
      },
      {
        "group": "GF4",
        "lot": "4",
        "count": 260285
      },
      {
        "group": "GF4",
        "lot": "5",
        "count": 49739
      },
      {
        "group": "GF4",
        "lot": "6",
        "count": 38525
      }
    ]
  },
  "lot_flag_matrix": {
    "lots": [
      "1",
      "2",
      "3",
      "4",
      "5",
      "6"
    ],
    "flags": [
      1,
      2,
      3,
      4
    ],
    "matrix": [
      {
        "lot": "1",
        "flag": 1,
        "count": 519938
      },
      {
        "lot": "1",
        "flag": 2,
        "count": 0
      },
      {
        "lot": "1",
        "flag": 3,
        "count": 0
      },
      {
        "lot": "1",
        "flag": 4,
        "count": 0
      },
      {
        "lot": "2",
        "flag": 1,
        "count": 424963
      },
      {
        "lot": "2",
        "flag": 2,
        "count": 1
      },
      {
        "lot": "2",
        "flag": 3,
        "count": 3695
      },
      {
        "lot": "2",
        "flag": 4,
        "count": 4
      },
      {
        "lot": "3",
        "flag": 1,
        "count": 572364
      },
      {
        "lot": "3",
        "flag": 2,
        "count": 0
      },
      {
        "lot": "3",
        "flag": 3,
        "count": 42
      },
      {
        "lot": "3",
        "flag": 4,
        "count": 202061
      },
      {
        "lot": "4",
        "flag": 1,
        "count": 681485
      },
      {
        "lot": "4",
        "flag": 2,
        "count": 913
      },
      {
        "lot": "4",
        "flag": 3,
        "count": 196935
      },
      {
        "lot": "4",
        "flag": 4,
        "count": 260285
      },
      {
        "lot": "5",
        "flag": 1,
        "count": 389451
      },
      {
        "lot": "5",
        "flag": 2,
        "count": 116
      },
      {
        "lot": "5",
        "flag": 3,
        "count": 193017
      },
      {
        "lot": "5",
        "flag": 4,
        "count": 49739
      },
      {
        "lot": "6",
        "flag": 1,
        "count": 456023
      },
      {
        "lot": "6",
        "flag": 2,
        "count": 564
      },
      {
        "lot": "6",
        "flag": 3,
        "count": 147517
      },
      {
        "lot": "6",
        "flag": 4,
        "count": 38525
      }
    ]
  },
  "metadata": {
    "generated_at": "2025-10-12T20:21:42.374242",
    "total_accounts": 4137638,
    "total_groups": 4,
    "total_lots": 6,
    "performance_mode": "constrained",
    "lot_consolidations": {},
    "has_group_flags": true
  }
};
        
        let currentColorScheme = 'pantone';
        let currentScaleType = 'log';
        let cellSizeValue = 50;
        let svg1 = null;
        let svg2 = null;
        let allCounts1 = [];
        let allCounts2 = [];
        
        const colorSchemes = {
            pantone: (t) => {
                const colors = ['#0F4C81', '#6667AB', '#BB2649', '#FFBE98', '#F5DF4D'];
                return d3.interpolateRgbBasis(colors)(t);
            },
            viridis: d3.interpolateViridis,
            plasma: d3.interpolatePlasma,
            inferno: d3.interpolateInferno,
            turbo: d3.interpolateTurbo,
            cool: (t) => {
                const colors = ['#08519c', '#3182bd', '#6baed6', '#c6dbef', '#f0f9ff'];
                return d3.interpolateRgbBasis(colors)(t);
            }
        };
        
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        function calculatePercentile(value, allValues) {
            if (allValues.length === 0) return 0;
            const sorted = allValues.filter(v => v > 0).sort((a, b) => a - b);
            const index = sorted.findIndex(v => v >= value);
            return (index / sorted.length) * 100;
        }
        
        function createColorScale(data, scaleType) {
            const nonZeroCounts = data.filter(d => d.count > 0).map(d => d.count);
            
            if (nonZeroCounts.length === 0) {
                return {
                    scale: () => '#1a1f3a',
                    minVal: 0,
                    maxVal: 0,
                    stats: { min: 0, q25: 0, median: 0, q75: 0, max: 0 }
                };
            }
            
            const sorted = nonZeroCounts.sort((a, b) => a - b);
            const stats = {
                min: sorted[0],
                q25: d3.quantile(sorted, 0.25),
                median: d3.quantile(sorted, 0.5),
                q75: d3.quantile(sorted, 0.75),
                max: sorted[sorted.length - 1]
            };
            
            let scale;
            let minVal = stats.min;
            let maxVal = stats.max;
            
            if (scaleType === 'log') {
                const logMin = Math.log10(minVal + 1);
                const logMax = Math.log10(maxVal + 1);
                
                scale = (value) => {
                    if (value === 0) return '#1a1f3a';
                    const logValue = Math.log10(value + 1);
                    const t = (logValue - logMin) / (logMax - logMin);
                    return colorSchemes[currentColorScheme](t);
                };
                
            } else if (scaleType === 'quantile') {
                const quantileScale = d3.scaleQuantile()
                    .domain(sorted)
                    .range(d3.range(0, 1, 0.05));
                
                scale = (value) => {
                    if (value === 0) return '#1a1f3a';
                    const t = quantileScale(value);
                    return colorSchemes[currentColorScheme](t);
                };
                
            } else {
                scale = (value) => {
                    if (value === 0) return '#1a1f3a';
                    const t = (value - minVal) / (maxVal - minVal);
                    return colorSchemes[currentColorScheme](t);
                };
            }
            
            return { scale, minVal, maxVal, stats };
        }
        
        function createGradientLegend(svgId, labelsId, colorInfo, scaleType) {
            const svg = d3.select(`#${svgId}`);
            svg.selectAll('*').remove();
            
            const width = 600;
            const height = 30;
            
            svg.attr('width', '100%')
               .attr('height', height)
               .attr('viewBox', `0 0 ${width} ${height}`)
               .attr('preserveAspectRatio', 'xMidYMid meet');
            
            const defs = svg.append('defs');
            const gradient = defs.append('linearGradient')
                .attr('id', `gradient-${svgId}`)
                .attr('x1', '0%')
                .attr('x2', '100%');
            
            const steps = 50;
            for (let i = 0; i <= steps; i++) {
                const t = i / steps;
                let value;
                
                if (scaleType === 'log') {
                    const logMin = Math.log10(colorInfo.minVal + 1);
                    const logMax = Math.log10(colorInfo.maxVal + 1);
                    const logValue = logMin + t * (logMax - logMin);
                    value = Math.pow(10, logValue) - 1;
                } else {
                    value = colorInfo.minVal + t * (colorInfo.maxVal - colorInfo.minVal);
                }
                
                gradient.append('stop')
                    .attr('offset', `${t * 100}%`)
                    .attr('stop-color', colorInfo.scale(value));
            }
            
            svg.append('rect')
                .attr('width', width)
                .attr('height', height)
                .attr('rx', 6)
                .style('fill', `url(#gradient-${svgId})`);
            
            const labelsDiv = document.getElementById(labelsId);
            labelsDiv.innerHTML = `
                <span class="legend-label">Min: ${formatNumber(Math.round(colorInfo.minVal))}</span>
                <span class="legend-label">Q1: ${formatNumber(Math.round(colorInfo.stats.q25))}</span>
                <span class="legend-label">Median: ${formatNumber(Math.round(colorInfo.stats.median))}</span>
                <span class="legend-label">Q3: ${formatNumber(Math.round(colorInfo.stats.q75))}</span>
                <span class="legend-label">Max: ${formatNumber(Math.round(colorInfo.maxVal))}</span>
            `;
        }
        
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName + '-content').classList.add('active');
        }
        
        function initializeGroupLotMatrix() {
            const data = VISUALIZATION_DATA.group_lot_matrix;
            document.getElementById('matrix-viz-1').innerHTML = '';
            
            allCounts1 = data.matrix.map(d => d.count);
            
            const groupTotals = {};
            const lotTotals = {};
            let grandTotal = 0;
            
            data.matrix.forEach(d => {
                if (!groupTotals[d.group]) groupTotals[d.group] = 0;
                if (!lotTotals[d.lot]) lotTotals[d.lot] = 0;
                groupTotals[d.group] += d.count;
                lotTotals[d.lot] += d.count;
                grandTotal += d.count;
            });
            
            const colorInfo = createColorScale(data.matrix, currentScaleType);
            
            const margin = {top: 120, right: 150, bottom: 80, left: 150};
            const cellSize = cellSizeValue;
            const groupsWithTotal = [...data.groups, 'TOTAL'];
            const lotsWithTotal = [...data.lots, 'TOTAL'];
            const width = Math.max(800, groupsWithTotal.length * cellSize + margin.left + margin.right);
            const height = Math.max(600, lotsWithTotal.length * cellSize + margin.top + margin.bottom);
            
            svg1 = d3.select('#matrix-viz-1')
                .append('svg')
                .attr('width', '100%')
                .attr('height', height)
                .attr('viewBox', `0 0 ${width} ${height}`)
                .attr('preserveAspectRatio', 'xMinYMin meet')
                .attr('role', 'img')
                .attr('aria-label', 'GROUP by LOT matrix');
            
            const xScale = d3.scaleBand()
                .domain(groupsWithTotal)
                .range([margin.left, width - margin.right])
                .padding(0.1);
            
            const yScale = d3.scaleBand()
                .domain(lotsWithTotal)
                .range([margin.top, height - margin.bottom])
                .padding(0.1);
            
            drawMatrix(svg1, data.matrix, xScale, yScale, 'group', 'lot', false, colorInfo, allCounts1);
            
            data.lots.forEach(lot => {
                const g = svg1.append('g')
                    .attr('transform', `translate(${xScale('TOTAL')}, ${yScale(lot)})`);
                g.append('rect')
                    .attr('width', xScale.bandwidth())
                    .attr('height', yScale.bandwidth())
                    .attr('fill', '#2a3456')
                    .attr('stroke', '#F5DF4D')
                    .attr('stroke-width', 2)
                    .attr('rx', 4);
                g.append('text')
                    .attr('x', xScale.bandwidth() / 2)
                    .attr('y', yScale.bandwidth() / 2)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle')
                    .attr('class', 'total-label')
                    .text(formatNumber(lotTotals[lot] || 0));
            });
            
            data.groups.forEach(group => {
                const g = svg1.append('g')
                    .attr('transform', `translate(${xScale(group)}, ${yScale('TOTAL')})`);
                g.append('rect')
                    .attr('width', xScale.bandwidth())
                    .attr('height', yScale.bandwidth())
                    .attr('fill', '#2a3456')
                    .attr('stroke', '#F5DF4D')
                    .attr('stroke-width', 2)
                    .attr('rx', 4);
                g.append('text')
                    .attr('x', xScale.bandwidth() / 2)
                    .attr('y', yScale.bandwidth() / 2)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle')
                    .attr('class', 'total-label')
                    .text(formatNumber(groupTotals[group] || 0));
            });
            
            const grandTotalG = svg1.append('g')
                .attr('transform', `translate(${xScale('TOTAL')}, ${yScale('TOTAL')})`);
            grandTotalG.append('rect')
                .attr('width', xScale.bandwidth())
                .attr('height', yScale.bandwidth())
                .attr('fill', '#BB2649')
                .attr('stroke', '#F5DF4D')
                .attr('stroke-width', 3)
                .attr('rx', 4);
            grandTotalG.append('text')
                .attr('x', xScale.bandwidth() / 2)
                .attr('y', yScale.bandwidth() / 2)
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle')
                .attr('fill', '#ffffff')
                .attr('font-size', '14px')
                .attr('font-weight', '700')
                .text(formatNumber(grandTotal));
            
            drawAxes(svg1, groupsWithTotal, lotsWithTotal, xScale, yScale, 'GROUPS →', 'LOTS ↓', margin, width, height);
            
            const groupTotal = Object.values(groupTotals).reduce((sum, val) => sum + val, 0);
            const lotTotal = Object.values(lotTotals).reduce((sum, val) => sum + val, 0);
            const verificationEl = document.getElementById('group-lot-verification');
            if (groupTotal === lotTotal && groupTotal === grandTotal) {
                verificationEl.innerHTML = `✅ Verification: GROUP totals (${formatNumber(groupTotal)}) = LOT totals (${formatNumber(lotTotal)}) = Grand Total (${formatNumber(grandTotal)})`;
                verificationEl.style.color = '#4ade80';
            } else {
                verificationEl.innerHTML = `⚠️ Warning: GROUP totals (${formatNumber(groupTotal)}) vs LOT totals (${formatNumber(lotTotal)}) vs Grand Total (${formatNumber(grandTotal)})`;
                verificationEl.style.color = '#f87171';
            }
            
            const scaleInfoEl = document.getElementById('group-lot-scale-info');
            const scaleTypeText = currentScaleType === 'log' ? 'Logarithmic' : (currentScaleType === 'quantile' ? 'Quantile' : 'Linear');
            scaleInfoEl.textContent = `Using ${scaleTypeText} scale | Range: ${formatNumber(Math.round(colorInfo.minVal))} - ${formatNumber(Math.round(colorInfo.maxVal))} accounts`;
            
            createGradientLegend('legend-gradient-1', 'legend-labels-1', colorInfo, currentScaleType);
        }
        
        function initializeLotFlagMatrix() {
            const data = VISUALIZATION_DATA.lot_flag_matrix;
            document.getElementById('matrix-viz-2').innerHTML = '';
            
            allCounts2 = data.matrix.map(d => d.count);
            
            const lotTotals = {};
            const flagTotals = {1: 0, 2: 0, 3: 0, 4: 0};
            let grandTotal = 0;
            
            data.matrix.forEach(d => {
                if (!lotTotals[d.lot]) lotTotals[d.lot] = 0;
                lotTotals[d.lot] += d.count;
                flagTotals[d.flag] += d.count;
                grandTotal += d.count;
            });
            
            const colorInfo = createColorScale(data.matrix, currentScaleType);
            
            const margin = {top: 120, right: 150, bottom: 80, left: 150};
            const cellSize = cellSizeValue;
            const flagLabels = data.flags.map(f => 'FLAG_' + f);
            const lotsWithTotal = [...data.lots, 'TOTAL'];
            const flagsWithTotal = [...flagLabels, 'TOTAL'];
            
            const width = Math.max(800, flagsWithTotal.length * cellSize + margin.left + margin.right);
            const height = Math.max(600, lotsWithTotal.length * cellSize + margin.top + margin.bottom);
            
            svg2 = d3.select('#matrix-viz-2')
                .append('svg')
                .attr('width', '100%')
                .attr('height', height)
                .attr('viewBox', `0 0 ${width} ${height}`)
                .attr('preserveAspectRatio', 'xMinYMin meet')
                .attr('role', 'img')
                .attr('aria-label', 'LOT by GROUP_FLAG matrix');
            
            const xScale = d3.scaleBand()
                .domain(flagsWithTotal)
                .range([margin.left, width - margin.right])
                .padding(0.1);
            
            const yScale = d3.scaleBand()
                .domain(lotsWithTotal)
                .range([margin.top, height - margin.bottom])
                .padding(0.1);
            
            drawMatrix(svg2, data.matrix, xScale, yScale, 'flag', 'lot', true, colorInfo, allCounts2);
            
            data.lots.forEach(lot => {
                const g = svg2.append('g')
                    .attr('transform', `translate(${xScale('TOTAL')}, ${yScale(lot)})`);
                g.append('rect')
                    .attr('width', xScale.bandwidth())
                    .attr('height', yScale.bandwidth())
                    .attr('fill', '#2a3456')
                    .attr('stroke', '#F5DF4D')
                    .attr('stroke-width', 2)
                    .attr('rx', 4);
                g.append('text')
                    .attr('x', xScale.bandwidth() / 2)
                    .attr('y', yScale.bandwidth() / 2)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle')
                    .attr('class', 'total-label')
                    .text(formatNumber(lotTotals[lot] || 0));
            });
            
            data.flags.forEach(flag => {
                const g = svg2.append('g')
                    .attr('transform', `translate(${xScale('FLAG_' + flag)}, ${yScale('TOTAL')})`);
                g.append('rect')
                    .attr('width', xScale.bandwidth())
                    .attr('height', yScale.bandwidth())
                    .attr('fill', '#2a3456')
                    .attr('stroke', '#F5DF4D')
                    .attr('stroke-width', 2)
                    .attr('rx', 4);
                g.append('text')
                    .attr('x', xScale.bandwidth() / 2)
                    .attr('y', yScale.bandwidth() / 2)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle')
                    .attr('class', 'total-label')
                    .text(formatNumber(flagTotals[flag] || 0));
            });
            
            const grandTotalG = svg2.append('g')
                .attr('transform', `translate(${xScale('TOTAL')}, ${yScale('TOTAL')})`);
            grandTotalG.append('rect')
                .attr('width', xScale.bandwidth())
                .attr('height', yScale.bandwidth())
                .attr('fill', '#BB2649')
                .attr('stroke', '#F5DF4D')
                .attr('stroke-width', 3)
                .attr('rx', 4);
            grandTotalG.append('text')
                .attr('x', xScale.bandwidth() / 2)
                .attr('y', yScale.bandwidth() / 2)
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle')
                .attr('fill', '#ffffff')
                .attr('font-size', '14px')
                .attr('font-weight', '700')
                .text(formatNumber(grandTotal));
            
            drawAxes(svg2, flagsWithTotal, lotsWithTotal, xScale, yScale, 'GROUP FLAGS →', 'LOTS ↓', margin, width, height);
            
            const lotSum = Object.values(lotTotals).reduce((s, v) => s + v, 0);
            const flagSum = Object.values(flagTotals).reduce((s, v) => s + v, 0);
            const v2 = document.getElementById('lot-flag-verification');
            if (v2) {
                if (lotSum === flagSum && lotSum === grandTotal) {
                    v2.textContent = `✅ Verification: LOT totals (${formatNumber(lotSum)}) = FLAG totals (${formatNumber(flagSum)}) = Grand Total (${formatNumber(grandTotal)})`;
                    v2.style.color = '#4ade80';
                } else {
                    v2.textContent = `⚠️ Warning: LOT totals (${formatNumber(lotSum)}) vs FLAG totals (${formatNumber(flagSum)}) vs Grand Total (${formatNumber(grandTotal)})`;
                    v2.style.color = '#f87171';
                }
            }
            
            const scaleInfoEl = document.getElementById('lot-flag-scale-info');
            const scaleTypeText = currentScaleType === 'log' ? 'Logarithmic' : (currentScaleType === 'quantile' ? 'Quantile' : 'Linear');
            scaleInfoEl.textContent = `Using ${scaleTypeText} scale | Range: ${formatNumber(Math.round(colorInfo.minVal))} - ${formatNumber(Math.round(colorInfo.maxVal))} accounts`;
            
            createGradientLegend('legend-gradient-2', 'legend-labels-2', colorInfo, currentScaleType);
        }
        
        function drawMatrix(svg, matrixData, xScale, yScale, xKey, yKey, isFlag, colorInfo, allCounts) {
            const cells = svg.selectAll('.cell-group')
                .data(matrixData)
                .enter()
                .append('g')
                .attr('class', 'cell-group')
                .attr('transform', d => {
                    const xVal = isFlag ? 'FLAG_' + d[xKey] : d[xKey];
                    const yVal = d[yKey];
                    return `translate(${xScale(xVal)}, ${yScale(yVal)})`;
                });
            
            cells.append('rect')
                .attr('class', 'cell')
                .attr('width', xScale.bandwidth())
                .attr('height', yScale.bandwidth())
                .attr('fill', d => colorInfo.scale(d.count))
                .attr('rx', 4)
                .on('mouseover', (event, d) => showTooltip(event, d, allCounts))
                .on('mousemove', moveTooltip)
                .on('mouseout', hideTooltip)
                .on('click', (event, d) => showDetails(d, allCounts));
            
            cells.append('text')
                .attr('x', xScale.bandwidth() / 2)
                .attr('y', yScale.bandwidth() / 2)
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle')
                .attr('fill', d => d.count > 0 ? '#ffffff' : '#a0a9c9')
                .attr('font-size', Math.min(14, xScale.bandwidth() / 3) + 'px')
                .attr('font-weight', '600')
                .attr('pointer-events', 'none')
                .text(d => d.count > 0 ? formatNumber(d.count) : '');
        }
        
        function drawAxes(svg, xLabels, yLabels, xScale, yScale, xTitle, yTitle, margin, width, height) {
            const labelTooltip = document.getElementById('labelTooltip');
            
            svg.selectAll('.x-label')
                .data(xLabels)
                .enter()
                .append('text')
                .attr('class', d => d === 'TOTAL' ? 'axis-label x-label total-label' : 'axis-label x-label')
                .attr('x', d => xScale(d) + xScale.bandwidth() / 2)
                .attr('y', 90)
                .attr('text-anchor', 'middle')
                .attr('font-size', '11px')
                .text(d => d.length > 15 ? d.substring(0, 15) + '...' : d)
                .on('mouseover', function(event, d) {
                    if (d.length > 15) {
                        labelTooltip.textContent = d;
                        labelTooltip.style.left = event.pageX + 'px';
                        labelTooltip.style.top = (event.pageY - 30) + 'px';
                        labelTooltip.classList.add('show');
                    }
                })
                .on('mouseout', () => labelTooltip.classList.remove('show'));
            
            svg.selectAll('.y-label')
                .data(yLabels)
                .enter()
                .append('text')
                .attr('class', d => d === 'TOTAL' ? 'axis-label y-label total-label' : 'axis-label y-label')
                .attr('x', 130)
                .attr('y', d => yScale(d) + yScale.bandwidth() / 2)
                .attr('text-anchor', 'end')
                .attr('dominant-baseline', 'middle')
                .attr('font-size', '11px')
                .text(d => d.length > 20 ? d.substring(0, 20) + '...' : d)
                .on('mouseover', function(event, d) {
                    if (d.length > 20) {
                        labelTooltip.textContent = d;
                        labelTooltip.style.left = event.pageX + 'px';
                        labelTooltip.style.top = event.pageY + 'px';
                        labelTooltip.classList.add('show');
                    }
                })
                .on('mouseout', () => labelTooltip.classList.remove('show'));
            
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;
            
            svg.append('text')
                .attr('x', margin.left + plotWidth / 2)
                .attr('y', 40)
                .attr('text-anchor', 'middle')
                .attr('fill', '#F5DF4D')
                .attr('font-size', '14px')
                .attr('font-weight', '600')
                .text(xTitle);
            
            svg.append('text')
                .attr('x', -(margin.top + plotHeight / 2))
                .attr('y', 20)
                .attr('text-anchor', 'middle')
                .attr('fill', '#F5DF4D')
                .attr('font-size', '14px')
                .attr('font-weight', '600')
                .attr('transform', 'rotate(-90, 20, 0)')
                .text(yTitle);
        }
        
        function showTooltip(event, d, allCounts) {
            const tooltip = document.getElementById('tooltip');
            const label1 = d.group || d.lot;
            const label2 = d.lot || ('FLAG_' + d.flag);
            const percentile = calculatePercentile(d.count, allCounts);
            
            tooltip.innerHTML = `
                <h3>${label1} × ${label2}</h3>
                <p class="count">${formatNumber(d.count)} accounts</p>
                <p style="font-size: 0.85rem; color: #a0a9c9;">Percentile: ${percentile.toFixed(1)}%</p>
            `;
            tooltip.classList.add('show');
        }
        
        function moveTooltip(event) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }
        
        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('show');
        }
        
        function showDetails(d, allCounts) {
            const label1 = d.group || d.lot;
            const label2 = d.lot || ('FLAG_' + d.flag);
            const percentile = calculatePercentile(d.count, allCounts);
            alert(`Details for ${label1} × ${label2}\n\nTotal Accounts: ${formatNumber(d.count)}\nPercentile: ${percentile.toFixed(1)}%`);
        }
        
        function updateStatistics() {
            const metadata = VISUALIZATION_DATA.metadata;
            
            if (metadata) {
                animateCounter('totalAccounts', metadata.total_accounts || 0);
                animateCounter('totalGroups', metadata.total_groups || 0);
                animateCounter('totalLots', metadata.total_lots || 0);
            }
            
            const flags = VISUALIZATION_DATA?.lot_flag_matrix?.flags ?? [];
            document.getElementById('totalFlags').textContent = formatNumber(flags.length);
        }
        
        function animateCounter(id, target) {
            const element = document.getElementById(id);
            const duration = 1000;
            const increment = target / (duration / 16);
            let current = 0;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                element.textContent = formatNumber(Math.round(current));
            }, 16);
        }
        
        function debounce(fn, ms = 100) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), ms);
            };
        }
        
        function setupEventListeners() {
            document.getElementById('colorScheme').addEventListener('change', (e) => {
                currentColorScheme = e.target.value;
                initializeGroupLotMatrix();
                initializeLotFlagMatrix();
            });
            
            document.getElementById('scaleType').addEventListener('change', (e) => {
                currentScaleType = e.target.value;
                initializeGroupLotMatrix();
                initializeLotFlagMatrix();
            });
            
            document.getElementById('cellSize').addEventListener('input', debounce((e) => {
                cellSizeValue = parseInt(e.target.value, 10);
                initializeGroupLotMatrix();
                initializeLotFlagMatrix();
            }));
        }
        
        function resetView() {
            document.getElementById('colorScheme').value = 'pantone';
            document.getElementById('scaleType').value = 'log';
            document.getElementById('cellSize').value = 50;
            currentColorScheme = 'pantone';
            currentScaleType = 'log';
            cellSizeValue = 50;
            initializeGroupLotMatrix();
            initializeLotFlagMatrix();
        }
        
        function exportData() {
            let csv = 'Matrix,Row,Column,Count\n';
            VISUALIZATION_DATA.group_lot_matrix.matrix.forEach(d => {
                csv += `GROUP×LOT,${d.group},${d.lot},${d.count}\n`;
            });
            VISUALIZATION_DATA.lot_flag_matrix.matrix.forEach(d => {
                csv += `LOT×FLAG,${d.lot},FLAG_${d.flag},${d.count}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dual_matrix_export.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            initializeGroupLotMatrix();
            initializeLotFlagMatrix();
            updateStatistics();
            setupEventListeners();
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') resetView();
        });
    </script>
</body>
</html>
